import{fa as di,gx as fi,x as f,y as p,z as pi,cL as gs,al as vi,kz as Nt,vH as _s,aq as ys,dy as K,d2 as xs,dq as cr,fB as Tt,dm as g,dS as $s,iR as mi,fR as k,dQ as ae,dR as W,vI as bs,jB as ii,fP as ge,iG as Pi,oR as ws,kl as Oe,aP as Ss,e3 as Ms,s as $t,c6 as nt,oU as te,vJ as Ts,jA as Bt,vs as Ht,vp as Cs,h1 as me,vK as Ps,cQ as zs,vL as As,dO as U,dp as de,dA as Ce,dn as Y,iV as we,et as X,ev as bt,fO as ri,vM as Os,dJ as ur,iF as Ge,iI as Ct,vN as hr,vO as dr,dl as Me,jK as Es,ax as zi,pZ as Is,as as Rs,kn as it,oS as Pt,iQ as Fs,dv as zt,ki as Fe,R as Ds,uS as ot,vP as rt,vQ as Ls,sg as Vs,iE as ks,iN as Ns,iy as Bs,hn as gi,dH as Ue,vR as Hs,vS as js,vT as fr,vU as Us,fC as Ne,tg as Ai,iX as Oi,lh as pr,dC as Ei,dF as Ii,dt as jt,fS as vr,vV as qs,vW as Ws,li as Gs,ej as Ee,rU as Xs,vX as Ri,dw as ue,kr as Fi,kq as si,kL as Ys,iW as lt,vY as Ks,eI as Di,fU as mr,uQ as Zs,gB as _i,vZ as Li,sj as Qs,eE as Le,fV as ni,B as gr,v_ as Js,cz as oe,aX as ai,j3 as _r,lc as Rt,kb as en,v$ as tn,f as rn,hx as sn,dB as nn,fQ as an,oT as on,iH as yr,ou as ln,du as xr,l as cn,c_ as un,it as $r,is as br,ao as wr,k2 as oi,fc as Vi}from"./index-D8xrrNs5.js";import{e as hn,A as dn}from"./Indices-DBH_6uMc.js";import{l as fn,s as B,g as Sr,h as pn,o as wt,m as vn,T as ki,f as Ni,J as Bi,p as mn,y as gn}from"./BufferView-Dzm_6Gf-.js";import{S as _n}from"./triangle-OskeU2LJ.js";import{c as yn,e as xn,l as Mr,r as $n,T as bn,d as wn}from"./renderState-CKc66y4x.js";import{t as m,n as se}from"./glsl-B5bJgrnA.js";import{n as Hi}from"./projectVectorToVector-Cjh7r3vk.js";import{h as Tr,x as Sn,y as Cr,k as Mn,S as Tn,w as Cn,O as Pn,d as zn,q as An,A as On}from"./frustum-DaQaPL1x.js";import{P as Ft,I as Pr,V as zr,b as Ar,k as Or,e as En,d as In}from"./sphere-DmvVz24G.js";import{f as Rn}from"./vectorStacks-Bgtw9D0s.js";import{G as Fn,K as Dn}from"./orientedBoundingBox-C-tpl0nO.js";import{i as ji}from"./projectPointToVector-HpsRih0X.js";import{m as Ln,v as Vn,b as kn}from"./lineSegment-DLeT9DaQ.js";import{L as Nn,U as Ui,j as qi,b as Bn,O as Wi,Z as Hn,k as jn}from"./plane-DY_3KHRQ.js";function vc(t,e=!1){return t<=di?e?new Array(t).fill(0):new Array(t):new Float32Array(t)}function mc(t){return(Array.isArray(t)?t.length:t.byteLength/8)<=di?Array.from(t):new Float32Array(t)}function gc(t,e,i){return Array.isArray(t)?t.slice(e,e+i):t.subarray(e,e+i)}let H=class extends fi{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};f([p()],H.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),f([p()],H.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),f([p()],H.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),f([p()],H.prototype,"DECONFLICTOR_SHOW_GRID",void 0),f([p()],H.prototype,"LABELS_SHOW_BORDER",void 0),f([p()],H.prototype,"TEXT_SHOW_BASELINE",void 0),f([p()],H.prototype,"TEXT_SHOW_BORDER",void 0),f([p()],H.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),f([p()],H.prototype,"OVERLAY_SHOW_CENTER",void 0),f([p()],H.prototype,"SHOW_POI",void 0),f([p()],H.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),f([p()],H.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),f([p()],H.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),f([p()],H.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),f([p()],H.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),f([p()],H.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),f([p()],H.prototype,"I3S_TREE_SHOW_TILES",void 0),f([p()],H.prototype,"I3S_SHOW_MODIFICATIONS",void 0),f([p()],H.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),f([p()],H.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),f([p()],H.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),f([p()],H.prototype,"LINE_WIREFRAMES",void 0),H=f([pi("esri.views.3d.support.debugFlags")],H);const Un=new H,ct=()=>vi.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),qn=542327876,Wn=131072,Gn=4;function yi(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function Xn(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const Yn=yi("DXT1"),Kn=yi("DXT3"),Zn=yi("DXT5"),Qn=31,Jn=0,ea=1,ta=2,ia=3,ra=4,sa=7,na=20,aa=21;function yc(t,e,i){const r=oa(i,e.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:n,width:a,height:o}=r;return e.samplingMode=s.levels.length>1?9987:9729,e.hasMipmap=s.levels.length>1,e.internalFormat=n,e.width=a,e.height=o,new gs(t,e,s)}function oa(t,e){const i=new Int32Array(t.buffer,t.byteOffset,Qn);if(i[Jn]!==qn)return ct().error("Invalid magic number in DDS header"),null;if(!(i[na]&Gn))return ct().error("Unsupported format, must contain a FourCC code"),null;const r=i[aa];let s,n;switch(r){case Yn:s=8,n=Nt.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Kn:s=16,n=Nt.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Zn:s=16,n=Nt.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return ct().error("Unsupported FourCC code:",Xn(r)),null}let a=1,o=i[ra],l=i[ia];(3&o||3&l)&&(ct().warn("Rounding up compressed texture size to nearest multiple of 4."),o=o+3&-4,l=l+3&-4);const u=o,c=l;let h,v;i[ta]&Wn&&e!==!1&&(a=Math.max(1,i[sa]));let _=t.byteOffset+i[ea]+4;const d=[];for(let b=0;b<a;++b)v=(o+3>>2)*(l+3>>2)*s,h=new Uint8Array(t.buffer,_,v),d.push(h),_+=v,o=Math.max(1,o>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:d},internalFormat:n,width:u,height:c}}function la(t){if(t.length<di)return Array.from(t);if(Array.isArray(t))return Float64Array.from(t);if(!("BYTES_PER_ELEMENT"in t))return Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return _s(t)?fn().from(t):ys(t)?Uint16Array.from(t):Int16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}let ca=class Er{get center(){return K(this._data[0],this._data[1],this._data[2])}get radius(){return this._data[3]}get bbMin(){return K(this._data[4],this._data[5],this._data[6])}get bbMax(){return K(this._data[7],this._data[8],this._data[9])}constructor(e,i,r){this.primitiveIndices=e,this._numIndexPerPrimitive=i,this.position=r,this._data=[.1,0,0,0,0,0,0,0,0,0],this._children=void 0,B(e.length>=1),B(r.size===3||r.size===4);const{data:s,size:n,indices:a}=r;B(a.length%this._numIndexPerPrimitive===0),B(a.length>=e.length*this._numIndexPerPrimitive);const o=e.length;let l=n*a[this._numIndexPerPrimitive*e[0]];Ie.clear(),Ie.push(l);const u=K(s[l],s[l+1],s[l+2]),c=cr(u);for(let d=0;d<o;++d){const b=this._numIndexPerPrimitive*e[d];for(let $=0;$<this._numIndexPerPrimitive;++$){l=n*a[b+$],Ie.push(l);let z=s[l];u[0]=Math.min(z,u[0]),c[0]=Math.max(z,c[0]),z=s[l+1],u[1]=Math.min(z,u[1]),c[1]=Math.max(z,c[1]),z=s[l+2],u[2]=Math.min(z,u[2]),c[2]=Math.max(z,c[2])}}for(let d=0;d<3;++d)this._data[4+d]=u[d],this._data[7+d]=c[d];const h=Tt(g(),this.bbMin,this.bbMax,.5);let v=.5*Math.max(Math.max(c[0]-u[0],c[1]-u[1]),c[2]-u[2]),_=v*v;for(let d=0;d<Ie.length;++d){l=Ie.at(d);const b=s[l]-h[0],$=s[l+1]-h[1],z=s[l+2]-h[2],A=b*b+$*$+z*z;if(A<=_)continue;const C=Math.sqrt(A),O=.5*(C-v);v+=O,_=v*v;const R=O/C;h[0]+=b*R,h[1]+=$*R,h[2]+=z*R}this._data[3]=v;for(let d=0;d<3;++d)this._data[0+d]=h[d];Ie.clear()}getChildren(){if(this._children||$s(this.bbMin,this.bbMax)<=1)return this._children;const e=Tt(g(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:a,indices:o}=this.position;for(let c=0;c<i;++c){let h=0;const v=this._numIndexPerPrimitive*this.primitiveIndices[c];let _=a*o[v],d=n[_],b=n[_+1],$=n[_+2];for(let z=1;z<this._numIndexPerPrimitive;++z){_=a*o[v+z];const A=n[_],C=n[_+1],O=n[_+2];A<d&&(d=A),C<b&&(b=C),O<$&&($=O)}d<e[0]&&(h|=1),b<e[1]&&(h|=2),$<e[2]&&(h|=4),r[c]=h,++s[h]}let l=0;for(let c=0;c<8;++c)s[c]>0&&++l;if(l<2)return;const u=new Array(8);for(let c=0;c<8;++c)u[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<i;++c){const h=r[c];u[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array;for(let c=0;c<8;++c)u[c]!==void 0&&this._children.push(new Er(u[c],this._numIndexPerPrimitive,this.position));return this._children}static prune(){Ie.prune()}};const Ie=new xs({deallocator:null});let ua=class{constructor(e){this.id=mi(),this._attributes=new Map;for(const[i,r]of e)this._attributes.set(i,{...r,indices:hn(r.indices)})}get attributes(){return this._attributes}};function ha(t,e){if(!t)return!1;const{size:i,data:r,indices:s}=t;k(e,0,0,0),k(ne,0,0,0);let n=0,a=0;for(let o=0;o<s.length-2;o+=3){const l=s[o]*i,u=s[o+1]*i,c=s[o+2]*i;k(G,r[l],r[l+1],r[l+2]),k($e,r[u],r[u+1],r[u+2]),k(ut,r[c],r[c+1],r[c+2]);const h=_n(G,$e,ut);h?(ae(G,G,$e),ae(G,G,ut),W(G,G,1/3*h),ae(e,e,G),n+=h):(ae(ne,ne,G),ae(ne,ne,$e),ae(ne,ne,ut),a+=3)}return(a!==0||n!==0)&&(n!==0?(W(e,e,1/n),!0):a!==0&&(W(e,ne,1/a),!0))}function da(t,e){if(!t)return!1;const{size:i,data:r,indices:s}=t;k(e,0,0,0);let n=-1,a=0;for(let o=0;o<s.length;o++){const l=s[o]*i;n!==l&&(e[0]+=r[l],e[1]+=r[l+1],e[2]+=r[l+2],a++),n=l}return a>1&&W(e,e,1/a),a>0}function fa(t,e,i){if(!t)return!1;k(i,0,0,0),k(ne,0,0,0);let r=0,s=0;const{size:n,data:a,indices:o}=t,l=o.length-1,u=l+(e?2:0);for(let c=0;c<u;c+=2){const h=c<l?c+1:0,v=o[c<l?c:l]*n,_=o[h]*n;G[0]=a[v],G[1]=a[v+1],G[2]=a[v+2],$e[0]=a[_],$e[1]=a[_+1],$e[2]=a[_+2],W(G,ae(G,G,$e),.5);const d=bs(G,$e);d>0?(ae(i,i,W(G,G,d)),r+=d):r===0&&(ae(ne,ne,G),s++)}return r!==0?(W(i,i,1/r),!0):s!==0&&(W(i,ne,1/s),!0)}const G=g(),$e=g(),ut=g(),ne=g();let Ir=class{constructor(){this.uid=mi()}},pa=class extends Ir{constructor(e){super(),this.highlightName=e,this.channel=0}},wc=class extends Ir{constructor(){super(...arguments),this.channel=1}},Mc=class Rr extends ua{constructor(e,i,r=null,s=0,n=null,a=-1,o){super(i),this.material=e,this.mapPositions=r,this.type=s,this.olidColor=n,this.edgeIndicesLength=a,this.baseGeometry=o,this._highlights=null,this._highlightOptionsCounts=null,this.visible=!0,this._boundingInfo=null;const l=this.positionAttribute;l!=null&&this.edgeIndicesLength<0&&(this.edgeIndicesLength=l.indices.length)}instantiate(e={}){const i=new Rr(e.material||this.material,[],this.mapPositions,this.type,this.olidColor,this.edgeIndicesLength,this.baseGeometry);return this._attributes.forEach((r,s)=>{r.exclusive=!1,i._attributes.set(s,r)}),i._boundingInfo=this._boundingInfo,i.transformation=e.transformation||this.transformation,i}getMutableAttribute(e){let i=this._attributes.get(e);return i&&!i.exclusive&&(i={...i,exclusive:!0,data:la(i.data)},this._attributes.set(e,i)),i}setAttributeData(e,i){const r=this._attributes.get(e);r?this._attributes.set(e,{...r,exclusive:!0,data:i}):ii()&&console.warn(`Setting undefined attribute ${e} data`)}get positionAttribute(){return this.attributes.get("position")??this.baseGeometry?.attributes.get("position")}get indexCount(){return this._attributes.values().next().value?.indices?.length??0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo??(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===0?this._computeAttachmentOriginTriangles(e):this.type===2?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(this._transformation!=null&&ge(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const i=this.positionAttribute;return ha(i,e)}_computeAttachmentOriginLines(e){const i=this.positionAttribute;return fa(i,va(this.material.parameters,i),e)}_computeAttachmentOriginPoints(e){const i=this.positionAttribute;return da(i,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.positionAttribute;if(!e||e.indices.length===0)return null;const i=this.type===0?3:1;B(e.indices.length%i===0,"Indexing error: "+e.indices.length+" not divisible by "+i);const r=dn(e.indices.length/i);return new ca(r,i,e)}get transformation(){return this._transformation??Pi}set transformation(e){this._transformation=e&&e!==Pi?ws(e):null}get highlights(){return this._highlights||ma}get hasHighlights(){return(this._highlightOptionsCounts?.size??0)>0}foreachHighlightOptions(e){this._highlightOptionsCounts?.forEach((i,r)=>e(r))}allocateIdAndHighlight(e){const i=new pa(e);return this.addHighlight(i)}addHighlight(e){this._ensureHighlights().add(e);const{highlightName:i}=e,r=(this._highlightOptionsCounts?.get(i)??0)+1;return this._ensureHighlightOptionsCounts().set(i,r),e}_ensureHighlights(){let e=this._highlights;return e||(e=new Set,this._highlights=e),e}_ensureHighlightOptionsCounts(){let e=this._highlightOptionsCounts;return e||(e=new Map,this._highlightOptionsCounts=e),e}removeHighlight(e){if(this._highlights?.delete(e)){const{highlightName:i}=e,r=this._highlightOptionsCounts?.get(i)??0;r<=1?this._highlightOptionsCounts?.delete(i):this._ensureHighlightOptionsCounts().set(i,r-1)}}};function va(t,e){return!(!("isClosed"in t)||!t.isClosed)&&e.indices.length>2}const ma=new Set;function ga(t){return t===4||t===5||t===6||t===7||t===8}function Tc(t){return ya(t)||t===3}function Fr(t){return t===9||t===10}function Cc(t){return Dr(t)||Fr(t)}function Dr(t){return t===0}function st(t){return Dr(t)||xi(t)}function Pc(t){return st(t)||t===10}function _a(t){return st(t)||Fr(t)}function ya(t){return _a(t)||Lr(t)}function Lr(t){return t===2}function xi(t){return t===1}function xa(t){return Lr(t)||ga(t)}let $a=class{constructor(e){this._material=e.material,this._techniques=e.techniques,this._output=e.output}dispose(){}get _stippleTextures(){return this._techniques.context?.stippleTextures}get _markerTextures(){return this._techniques.context?.markerTextures}getTechnique(e,i){return this._techniques.get(e,this._material.getConfiguration(this._output,i))}ensureResources(e){return 2}},ba=class{};const Dt=ba;let Oc=class extends $a{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textures=e.textures,this.updateTexture(e.textureId),this._acquire(e.normalTextureId,i=>this._textureNormal=i),this._acquire(e.emissiveTextureId,i=>this._textureEmissive=i),this._acquire(e.occlusionTextureId,i=>this._textureOcclusion=i),this._acquire(e.metallicRoughnessTextureId,i=>this._textureMetallicRoughness=i)}dispose(){super.dispose(),this._texture=Oe(this._texture),this._textureNormal=Oe(this._textureNormal),this._textureEmissive=Oe(this._textureEmissive),this._textureOcclusion=Oe(this._textureOcclusion),this._textureMetallicRoughness=Oe(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return this._numLoading===0?2:1}get textureBindParameters(){return new Sa(this._texture?.glTexture??null,this._textureNormal?.glTexture??null,this._textureEmissive?.glTexture??null,this._textureOcclusion?.glTexture??null,this._textureMetallicRoughness?.glTexture??null)}updateTexture(e){this._texture!=null&&e===this._texture.id||(this._texture=Oe(this._texture),this._acquire(e,i=>this._texture=i))}_acquire(e,i){if(e==null)return void i(null);const r=this._textures.acquire(e);if(Ss(r))return++this._numLoading,void r.then(s=>{if(this._disposed)return Oe(s),void i(null);i(s)}).finally(()=>--this._numLoading);i(r)}},wa=class extends Dt{constructor(e=null){super(),this.textureEmissive=e}},Sa=class extends wa{constructor(e,i,r,s,n,a,o){super(r),this.texture=e,this.textureNormal=i,this.textureOcclusion=s,this.textureMetallicRoughness=n,this.scale=a,this.normalTextureTransformMatrix=o}},Ma=class{constructor(e){this._bits=[...e]}equals(e){return Ms(this._bits,e.bits)}get code(){return this._code??(this._code=String.fromCharCode(...this._bits)),this._code}get bits(){return this._bits}},Ta=class extends Dt{constructor(){super(),this._parameterBits=this._parameterBits?.map(()=>0)??[],this._parameterNames??(this._parameterNames=[])}get key(){return this._key??(this._key=new Ma(this._parameterBits)),this._key}decode(e=this.key){const i=this._parameterBits;this._parameterBits=[...e.bits];const r=this._parameterNames.map(s=>`    ${s}: ${this[s]}`).join(`
`);return this._parameterBits=i,r}};function ht(t={}){return(e,i)=>{e.hasOwnProperty("_parameterNames")||Object.defineProperty(e,"_parameterNames",{value:e._parameterNames?.slice()??[],configurable:!0,writable:!0}),e.hasOwnProperty("_parameterBits")||Object.defineProperty(e,"_parameterBits",{value:e._parameterBits?.slice()??[0],configurable:!0,writable:!0}),e._parameterNames.push(i);const r=t.count||2,s=Math.ceil(Math.log2(r)),n=e._parameterBits;let a=0;for(;n[a]+s>16;)a++,a>=n.length&&n.push(0);const o=n[a],l=(1<<s)-1<<o;n[a]+=s,t.count?Object.defineProperty(e,i,{get(){return(this._parameterBits[a]&l)>>o},set(u){if(this[i]!==u){if(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~l|+u<<o&l,typeof u!="number")throw new $t("internal:invalid-shader-configuration",`Configuration value for ${i} must be a number, got ${typeof u}`);if(t.count==null)throw new $t("internal:invalid-shader-configuration",`Configuration value for ${i} must provide a count option`)}}}):Object.defineProperty(e,i,{get(){return!!((this._parameterBits[a]&l)>>o)},set(u){if(this[i]!==u&&(this._key=null,this._parameterBits[a]=this._parameterBits[a]&~l|+u<<o&l,typeof u!="boolean"))throw new $t("internal:invalid-shader-configuration",`Configuration value for ${i} must be boolean, got ${typeof u}`)}})}}let Ca=class extends Ta{constructor(){super(...arguments),this.instancedDoublePrecision=!1,this.hasModelTransformation=!1}},et=class extends Ca{constructor(){super(...arguments),this.output=0,this.oitPass=0,this.hasSlicePlane=!1,this.hasHighlightMixTexture=!1,this.bindType=1,this.instanced=!1,this.writeDepth=!0}};f([ht({count:11})],et.prototype,"output",void 0),f([ht({count:3})],et.prototype,"oitPass",void 0),f([ht()],et.prototype,"hasSlicePlane",void 0),f([ht()],et.prototype,"hasHighlightMixTexture",void 0);let li=class{constructor(){this._scale=0,this._angleFactor=0,this._minScale=0}update(e,i,r,s){r?(this._scale=Math.min(r.divisor/(i-r.offset),1),this._angleFactor=Pa(e),this._minScale=s!=null?Math.min(r.minPixelSize/s,1):0):(this._scale=1,this._minScale=1,this._angleFactor=1)}apply(e){const{_scale:i,_angleFactor:r,_minScale:s}=this;return e*nt(te(i,1,r),s,1)}applyVec2(e,i){e[0]=this.apply(i[0]),e[1]=this.apply(i[1])}},Nc=class{constructor(){this.evaluator=new li,this.alignmentEvaluator=new li}update(e,i,r,s,n,a){this.evaluator.update(e,i,r,s),this.alignmentEvaluator.update(e,i,n??r,(n?a:null)??s)}};function Pa(t){return Math.abs(t)**3}function Hc(t){return!!t&&!0}function jc(t,e,i,r,s,n){let a=i.screenLength*t.pixelRatio;s!=null&&(Xi.update(r,e,s,n),a=Xi.apply(a));const o=a*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return nt(o*e,i.minWorldLength,i.maxWorldLength)}const za=Ts();function Gi(t,e){let i=!1;for(const r in e){const s=e[r];s!==void 0&&(Array.isArray(s)?Array.isArray(t[r])&&za(s,t[r])||(t[r]=s.slice(),i=!0):t[r]!==s&&(i=!0,t[r]=s))}return i}const Uc={multiply:1,ignore:2,replace:3,tint:4},Xi=new li;let qc=class{constructor(e,i){this.id=mi(),this.supportsEdges=!1,this._renderPriority=0,this._parameters=new i,Gi(this._parameters,e),this.validateParameters(this._parameters)}get parameters(){return this._parameters}update(e){return!1}setParameters(e,i=!0){Gi(this._parameters,e)&&(this.validateParameters(this._parameters),i&&this._parametersChanged())}validateParameters(e){}shouldRender(e){return this.visible&&this.isVisibleForOutput(e.output)&&(!this.parameters.isDecoration||e.bind.decorations)&&(this.parameters.renderOccluded&e.renderOccludedMask)!==0}isVisibleForOutput(e){return!0}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this._parametersChanged())}_parametersChanged(){this.repository?.materialChanged(this)}get renderOccludedFlags(){return this.visible?this.parameters.renderOccluded:0}get hasEmissions(){return!1}getConfiguration(e,i,r=new et){return r.output=e,r.hasHighlightMixTexture=e===9&&i.highlightMixTexture!=null,r}},Gc=class extends Dt{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}};const Aa=xn(1,0,1,771);function Yc(t,e=!1){switch(t){case 0:return e?Mr:$n;case 1:return Aa;case 2:case 3:return null}}function Kc(t){if(t.draped)return null;switch(t.oitPass){case 0:case 2:return t.writeDepth?yn:null;case 1:case 3:return null}}const Zc=5e5,Oa={factor:-1,units:-2};function Qc({oitPass:t,enableOffset:e}){return e&&t===1?Oa:null}function Jc(t,e=513){return t===0||t===2?e:515}function eu(t,e){const i=xi(e);return t===1?i?{buffers:[Bt,Ht,Cs]}:{buffers:[Bt,Ht]}:i?{buffers:[Bt,Ht]}:null}let Ea=class{constructor(e=0,i=!1,r=!0){this.tolerance=e,this.isVerticalRay=i,this.normalRequired=r}};const dt=zs();function iu(t,e,i,r,s,n){if(!t.visible)return;const a=me(Hr,r,i),o=(c,h,v)=>n(c,v,h),{tolerance:l}=e,u=new Ea(l,!1,e.options.normalRequired);if(t.boundingInfo)B(t.type===0),Vr(t.boundingInfo,i,a,l,s,u,o);else{const c=t.positionAttribute,h=c.indices;kr(i,a,0,h.length/3,h,c.data,c.stride,s,u,o)}}const Ia=g();function Vr(t,e,i,r,s,n,a){if(t==null)return;const o=Ba(i,Ia);if(Ps(dt,t.bbMin),As(dt,t.bbMax),s?.applyToAabb(dt),Ha(dt,e,o,r)){const{primitiveIndices:l,position:u}=t,c=l?l.length:u.indices.length/3;if(c>Ua){const h=t.getChildren();if(h!==void 0){for(const v of h)Vr(v,e,i,r,s,n,a);return}}Da(e,i,0,c,u.indices,u.data,u.stride,l,s,n,a)}}const qe=g();function ru(t,e,i,r,s,n,a,o,l){const{data:u,stride:c}=n;kr(t,me(Hr,e,t),i,r,s,u,c,a,o,l)}function su(t,e,i,r){if(!i.visible)return;const s=(l,u,c)=>r(l,c,u),{boundingInfo:n}=i;if(n){const{bbMin:l,bbMax:u}=n;if(t<l[0]||t>u[0]||e<l[1]||e>u[1])return}const a=i.positionAttribute,o=a.indices;Ra(t,e,0,o.length/3,o,a,s)}function Ra(t,e,i,r,s,n,a){const{data:o,stride:l}=n;for(let u=i;u<r;++u){const c=3*u,h=l*s[c],v=l*s[c+1],_=l*s[c+2],d=o[h+0]-t,b=o[h+1]-e,$=o[v+0]-t,z=o[v+1]-e,A=o[_+0]-t,C=o[_+1]-e,O=A*z-C*$,R=d*C-b*A,D=$*b-z*d;(O<0||R<0||D<0)&&(O>0||R>0||D>0)||a(0,u,null)}}function Fa(t,e,i,r,s,n,a,o){const l=t[0],u=t[1],c=t[2],h=e[0],v=e[1],_=e[2];for(let d=i;d<r;++d){const b=3*d,$=b+1,z=b+2,A=n*b,C=s[A],O=s[A+1],R=s[A+2],D=n*$,T=n*z,w=s[D]-C,x=s[D+1]-O,E=s[D+2]-R,y=s[T]-C,S=s[T+1]-O,M=s[T+2]-R,F=v*M-S*_,L=_*y-M*h,V=h*S-y*v,N=w*F+x*L+E*V;if(Math.abs(N)<=Br)continue;const Z=l-C,ie=u-O,le=c-R,J=Z*F+ie*L+le*V;if(N>0){if(J<0||J>N)continue}else if(J>0||J<N)continue;const re=ie*E-x*le,fe=le*w-E*Z,pe=Z*x-w*ie,ce=h*re+v*fe+_*pe;if(N>0){if(ce<0||J+ce>N)continue}else if(ce>0||J+ce<N)continue;const ee=(y*re+S*fe+M*pe)/N;ee>=0&&o(ee,d,a?Nr(w,x,E,y,S,M,qe):null)}}function Da(t,e,i,r,s,n,a,o,l,u,c){const h=t[0],v=t[1],_=t[2],d=e[0],b=e[1],$=e[2],{normalRequired:z}=u;for(let A=i;A<r;++A){const C=o[A],O=3*C,R=a*s[O];let D=n[R],T=n[R+1],w=n[R+2];const x=a*s[O+1];let E=n[x],y=n[x+1],S=n[x+2];const M=a*s[O+2];let F=n[M],L=n[M+1],V=n[M+2];l!=null&&([D,T,w]=l.applyToVertex(D,T,w,A),[E,y,S]=l.applyToVertex(E,y,S,A),[F,L,V]=l.applyToVertex(F,L,V,A));const N=E-D,Z=y-T,ie=S-w,le=F-D,J=L-T,re=V-w,fe=b*re-J*$,pe=$*le-re*d,ce=d*J-le*b,ee=N*fe+Z*pe+ie*ce;if(Math.abs(ee)<=Br)continue;const Ve=h-D,Vt=v-T,kt=_-w,ke=Ve*fe+Vt*pe+kt*ce;if(ee>0){if(ke<0||ke>ee)continue}else if(ke>0||ke<ee)continue;const Si=Vt*ie-Z*kt,Mi=kt*N-ie*Ve,Ti=Ve*Z-N*Vt,at=d*Si+b*Mi+$*Ti;if(ee>0){if(at<0||ke+at>ee)continue}else if(at>0||ke+at<ee)continue;const Ci=(le*Si+J*Mi+re*Ti)/ee;Ci>=0&&c(Ci,C,z?Nr(N,Z,ie,le,J,re,qe):null)}}function kr(t,e,i,r,s,n,a,o,l,u){const c=e,h=qa,v=Math.abs(c[0]),_=Math.abs(c[1]),d=Math.abs(c[2]),b=v>=_?v>=d?0:2:_>=d?1:2,$=b,z=c[$]<0?2:1,A=(b+z)%3,C=(b+(3-z))%3,O=c[A]/c[$],R=c[C]/c[$],D=1/c[$],T=La,w=Va,x=ka,{normalRequired:E}=l;for(let y=i;y<r;++y){const S=3*y,M=a*s[S];k(h[0],n[M+0],n[M+1],n[M+2]);const F=a*s[S+1];k(h[1],n[F+0],n[F+1],n[F+2]);const L=a*s[S+2];k(h[2],n[L+0],n[L+1],n[L+2]),o&&(U(h[0],o.applyToVertex(h[0][0],h[0][1],h[0][2],y)),U(h[1],o.applyToVertex(h[1][0],h[1][1],h[1][2],y)),U(h[2],o.applyToVertex(h[2][0],h[2][1],h[2][2],y))),me(T,h[0],t),me(w,h[1],t),me(x,h[2],t);const V=T[A]-O*T[$],N=T[C]-R*T[$],Z=w[A]-O*w[$],ie=w[C]-R*w[$],le=x[A]-O*x[$],J=x[C]-R*x[$],re=le*ie-J*Z,fe=V*J-N*le,pe=Z*N-ie*V;if((re<0||fe<0||pe<0)&&(re>0||fe>0||pe>0))continue;const ce=re+fe+pe;if(ce===0)continue;const ee=re*(D*T[$])+fe*(D*w[$])+pe*(D*x[$]);if(ee*Math.sign(ce)<0)continue;const Ve=ee/ce;Ve>=0&&u(Ve,y,E?Na(h):null)}}const La=g(),Va=g(),ka=g();function Nr(t,e,i,r,s,n,a){return k(At,t,e,i),k(Ot,r,s,n),de(a,At,Ot),Ce(a,a),a}function Na(t){return me(At,t[1],t[0]),me(Ot,t[2],t[0]),de(qe,At,Ot),Ce(qe,qe),qe}const At=g(),Ot=g();function Ba(t,e){return k(e,1/t[0],1/t[1],1/t[2])}function Ha(t,e,i,r){return ja(t,e,i,r,1/0)}function ja(t,e,i,r,s){const n=(t[0]-r-e[0])*i[0],a=(t[3]+r-e[0])*i[0];let o=Math.min(n,a),l=Math.max(n,a);const u=(t[1]-r-e[1])*i[1],c=(t[4]+r-e[1])*i[1];if(l=Math.min(l,Math.max(u,c)),l<0||(o=Math.max(o,Math.min(u,c)),o>l))return!1;const h=(t[2]-r-e[2])*i[2],v=(t[5]+r-e[2])*i[2];return l=Math.min(l,Math.max(h,v)),!(l<0)&&(o=Math.max(o,Math.min(h,v)),!(o>l)&&o<s)}const Ua=1e3,Br=1e-7,Hr=g(),qa=[g(),g(),g()];let nu=class{constructor(){this._transform=X(),this._transformInverse=new ft({value:this._transform},bt,X),this._transformInverseTranspose=new ft(this._transformInverse,ri,X),this._transformTranspose=new ft({value:this._transform},ri,X),this._transformInverseRotation=new ft({value:this._transform},Os,ur)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){Ge(this._transform,e)}multiplyTransform(e){Ct(this._transform,this._transform,e)}set(e){Ge(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,i){this.setTransformMatrix(e),this.multiplyTransform(i),this._invalidateLazyTransforms()}},ft=class{constructor(e,i,r){this._original=e,this._update=i,this._dirty=!0,this._transform=r()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}},Wa=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=g(),this._tmpMbs=Ft(),this._tmpObb=new Fn,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=Y(e)}applyToVertex(e,i,r){const s=k(jr,e,i,r),n=k(Xa,e,i,r+this.componentLocalOriginLength),a=this._totalOffset/Y(n);return we(this._tmpVertex,s,n,a),this._tmpVertex}applyToAabb(e){const i=this.componentLocalOriginLength,r=e[0],s=e[1],n=e[2]+i,a=e[3],o=e[4],l=e[5]+i,u=Math.abs(r),c=Math.abs(s),h=Math.abs(n),v=Math.abs(a),_=Math.abs(o),d=Math.abs(l),b=.5*(1+Math.sign(r*a))*Math.min(u,v),$=.5*(1+Math.sign(s*o))*Math.min(c,_),z=.5*(1+Math.sign(n*l))*Math.min(h,d),A=Math.max(u,v),C=Math.max(c,_),O=Math.max(h,d),R=Math.sqrt(b*b+$*$+z*z),D=Math.sign(u+r),T=Math.sign(c+s),w=Math.sign(h+n),x=Math.sign(v+a),E=Math.sign(_+o),y=Math.sign(d+l),S=this._totalOffset;if(R<S)return e[0]-=(1-D)*S,e[1]-=(1-T)*S,e[2]-=(1-w)*S,e[3]+=x*S,e[4]+=E*S,e[5]+=y*S,e;const M=S/Math.sqrt(A*A+C*C+O*O),F=S/R,L=F-M,V=-L;return e[0]+=r*(D*V+F),e[1]+=s*(T*V+F),e[2]+=n*(w*V+F),e[3]+=a*(x*L+M),e[4]+=o*(E*L+M),e[5]+=l*(y*L+M),e}applyToMbs(e){const i=Pr(e),r=Y(i),s=this._totalOffset/r,n=we(Ur,i,i,s),a=e[3]+e[3]*this._totalOffset/r;return zr(this._tmpMbs,n,a),this._tmpMbs}applyToObb(e){return Dn(e,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}},Ga=class{constructor(e=0){this.offset=e,this.sphere=Ft(),this.tmpVertex=g()}applyToVertex(e,i,r){const s=this.objectTransform.transform,n=k(jr,e,i,r),a=ge(n,n,s),o=this.offset/Y(a);we(a,a,a,o);const l=this.objectTransform.inverse;return ge(this.tmpVertex,a,l),this.tmpVertex}applyToMinMax(e,i){const r=this.offset/Y(e);we(e,e,e,r);const s=this.offset/Y(i);we(i,i,i,s)}applyToAabb(e){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}applyToBoundingSphere(e){const i=Pr(e),r=Y(i),s=this.offset/r,n=we(Ur,i,i,s),a=e[3]+e[3]*this.offset/r;return zr(this.sphere,n,a),this.sphere}};const Yi=new Ga;function uu(t){return t!=null?(Yi.offset=t,Yi):null}new Wa;const jr=g(),Xa=g(),Ur=g();function hu(t,e,i,r=1){const{data:s,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;if(i*=o,r===1)for(let u=0;u<l;++u)a[i]=s[n[u]],i+=o;else for(let u=0;u<l;++u){const c=s[n[u]];for(let h=0;h<r;h++)a[i]=c,i+=o}}function Ut(t,e,i){const{data:r,indices:s}=t,n=e.typedBuffer,a=e.typedBufferStride,o=s.length;i*=a;for(let l=0;l<o;++l){const u=2*s[l];n[i]=r[u],n[i+1]=r[u+1],i+=a}}function $i(t,e,i,r=1){const{data:s,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;if(i*=o,r===1)for(let u=0;u<l;++u){const c=3*n[u];a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],i+=o}else for(let u=0;u<l;++u){const c=3*n[u];for(let h=0;h<r;++h)a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],i+=o}}function qr(t,e,i,r=1){const{data:s,indices:n}=t,a=e.typedBuffer,o=e.typedBufferStride,l=n.length;if(i*=o,r===1)for(let u=0;u<l;++u){const c=4*n[u];a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],a[i+3]=s[c+3],i+=o}else for(let u=0;u<l;++u){const c=4*n[u];for(let h=0;h<r;++h)a[i]=s[c],a[i+1]=s[c+1],a[i+2]=s[c+2],a[i+3]=s[c+3],i+=o}}function du(t,e,i){const r=t.typedBuffer,s=t.typedBufferStride;e*=s;for(let n=0;n<i;++n)r[e]=0,r[e+1]=0,r[e+2]=0,r[e+3]=0,e+=s}function Ya(t,e,i,r,s=1){if(!e)return void $i(t,i,r,s);const{data:n,indices:a}=t,o=i.typedBuffer,l=i.typedBufferStride,u=a.length,c=e[0],h=e[1],v=e[2],_=e[4],d=e[5],b=e[6],$=e[8],z=e[9],A=e[10],C=e[12],O=e[13],R=e[14];r*=l;let D=0,T=0,w=0;const x=hr(e)?E=>{D=n[E]+C,T=n[E+1]+O,w=n[E+2]+R}:E=>{const y=n[E],S=n[E+1],M=n[E+2];D=c*y+_*S+$*M+C,T=h*y+d*S+z*M+O,w=v*y+b*S+A*M+R};if(s===1)for(let E=0;E<u;++E)x(3*a[E]),o[r]=D,o[r+1]=T,o[r+2]=w,r+=l;else for(let E=0;E<u;++E){x(3*a[E]);for(let y=0;y<s;++y)o[r]=D,o[r+1]=T,o[r+2]=w,r+=l}}function Ka(t,e,i,r,s=1){if(!e)return void $i(t,i,r,s);const{data:n,indices:a}=t,o=e,l=i.typedBuffer,u=i.typedBufferStride,c=a.length,h=o[0],v=o[1],_=o[2],d=o[4],b=o[5],$=o[6],z=o[8],A=o[9],C=o[10],O=!dr(o),R=1e-6,D=1-R;r*=u;let T=0,w=0,x=0;const E=hr(o)?y=>{T=n[y],w=n[y+1],x=n[y+2]}:y=>{const S=n[y],M=n[y+1],F=n[y+2];T=h*S+d*M+z*F,w=v*S+b*M+A*F,x=_*S+$*M+C*F};if(s===1)if(O)for(let y=0;y<c;++y){E(3*a[y]);const S=T*T+w*w+x*x;if(S<D&&S>R){const M=1/Math.sqrt(S);l[r]=T*M,l[r+1]=w*M,l[r+2]=x*M}else l[r]=T,l[r+1]=w,l[r+2]=x;r+=u}else for(let y=0;y<c;++y)E(3*a[y]),l[r]=T,l[r+1]=w,l[r+2]=x,r+=u;else for(let y=0;y<c;++y){if(E(3*a[y]),O){const S=T*T+w*w+x*x;if(S<D&&S>R){const M=1/Math.sqrt(S);T*=M,w*=M,x*=M}}for(let S=0;S<s;++S)l[r]=T,l[r+1]=w,l[r+2]=x,r+=u}}function Za(t,e,i,r,s=1){if(!e)return void qr(t,i,r,s);const{data:n,indices:a}=t,o=e,l=i.typedBuffer,u=i.typedBufferStride,c=a.length,h=o[0],v=o[1],_=o[2],d=o[4],b=o[5],$=o[6],z=o[8],A=o[9],C=o[10],O=!dr(o),R=1e-6,D=1-R;if(r*=u,s===1)for(let T=0;T<c;++T){const w=4*a[T],x=n[w],E=n[w+1],y=n[w+2],S=n[w+3];let M=h*x+d*E+z*y,F=v*x+b*E+A*y,L=_*x+$*E+C*y;if(O){const V=M*M+F*F+L*L;if(V<D&&V>R){const N=1/Math.sqrt(V);M*=N,F*=N,L*=N}}l[r]=M,l[r+1]=F,l[r+2]=L,l[r+3]=S,r+=u}else for(let T=0;T<c;++T){const w=4*a[T],x=n[w],E=n[w+1],y=n[w+2],S=n[w+3];let M=h*x+d*E+z*y,F=v*x+b*E+A*y,L=_*x+$*E+C*y;if(O){const V=M*M+F*F+L*L;if(V<D&&V>R){const N=1/Math.sqrt(V);M*=N,F*=N,L*=N}}for(let V=0;V<s;++V)l[r]=M,l[r+1]=F,l[r+2]=L,l[r+3]=S,r+=u}}function Qa(t,e,i,r,s=1){const{data:n,indices:a}=t,o=i.typedBuffer,l=i.typedBufferStride,u=a.length;if(r*=l,e===n.length&&e===4){o[r]=n[0],o[r+1]=n[1],o[r+2]=n[2],o[r+3]=n[3];const c=new Uint32Array(i.typedBuffer.buffer,i.start),h=l/4,v=c[r/=4];r+=h;const _=u*s;for(let d=1;d<_;++d)c[r]=v,r+=h;return}if(s!==1)if(e!==4)for(let c=0;c<u;++c){const h=3*a[c];for(let v=0;v<s;++v)o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=255,r+=l}else for(let c=0;c<u;++c){const h=4*a[c];for(let v=0;v<s;++v)o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=n[h+3],r+=l}else{if(e===4){for(let c=0;c<u;++c){const h=4*a[c];o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=n[h+3],r+=l}return}for(let c=0;c<u;++c){const h=3*a[c];o[r]=n[h],o[r+1]=n[h+1],o[r+2]=n[h+2],o[r+3]=255,r+=l}}}function Ja(t,e,i){const{data:r,indices:s}=t,n=e.typedBuffer,a=e.typedBufferStride,o=s.length,l=r[0];i*=a;for(let u=0;u<o;++u)n[i]=l,i+=a}function fu(t,e,i,r){Me(Re,t,e);const s=Math.max(Math.sqrt(Y(Re)),1e-4);W(Re,Re,1/s),i[r++]=Re[0],i[r++]=Re[1],i[r++]=Re[2],i[r++]=s}const Re=g();function eo(t,e,i,r,s=1){const n=e.typedBuffer,a=e.typedBufferStride;if(r*=a,s===1)for(let o=0;o<i;++o)n[r]=t[0],n[r+1]=t[1],n[r+2]=t[2],n[r+3]=t[3],r+=a;else for(let o=0;o<i;++o)for(let l=0;l<s;++l)n[r]=t[0],n[r+1]=t[1],n[r+2]=t[2],n[r+3]=t[3],r+=a}function to(t,e,i,r,s,n,a){let o={numItems:0,numVerticesPerItem:0};for(const l of i.fields.keys()){const u=t.get(l),c=u?.indices;if(u&&c)l==="position"&&(o={numItems:1,numVerticesPerItem:c.length}),io(l,u,r,s,n,a);else if(l==="olidColor"&&e!=null){const h=t.get("position")?.indices;if(h){const v=h.length;eo(e,n.getField(l,Sr),v,a)}}}return o}function io(t,e,i,r,s,n){switch(t){case"position":{B(e.size===3);const a=s.getField(t,wt);B(!!a,`No buffer view for ${t}`),Ya(e,i,a,n);break}case"normal":{B(e.size===3);const a=s.getField(t,wt);B(!!a,`No buffer view for ${t}`),Ka(e,r,a,n);break}case"normalCompressed":case"profileRight":case"profileUp":{B(e.size===2);const a=s.getField(t,Bi);B(!!a,`No buffer view for ${t}`),Ut(e,a,n);break}case"uv0":{B(e.size===2);const a=s.getField(t,mn)??s.getField(t,gn);B(!!a,`No buffer view for ${t}`),Ut(e,a,n);break}case"uvi":{B(e.size===2);const a=s.getField(t,Bi);B(!!a,`No buffer view for ${t}`),Ut(e,a,n);break}case"color":case"symbolColor":{const a=s.getField(t,Sr);B(!!a,`No buffer view for ${t}`),B(e.size===3||e.size===4),Qa(e,e.size,a,n);break}case"colorFeatureAttribute":case"opacityFeatureAttribute":case"sizeFeatureAttribute":{const a=s.getField(t,Ni)??s.getField(t,Ni);B(!!a,`No buffer view for ${t}`),B(e.size===1),Ja(e,a,n);break}case"tangent":{B(e.size===4);const a=s.getField(t,ki);B(!!a,`No buffer view for ${t}`),Za(e,i,a,n);break}case"profileVertexAndNormal":{B(e.size===4);const a=s.getField(t,vn)??s.getField(t,ki);B(!!a,`No buffer view for ${t}`),qr(e,a,n);break}case"profileAuxData":{B(e.size===3);const a=s.getField(t,pn)??s.getField(t,wt);B(!!a,`No buffer view for ${t}`),$i(e,a,n);break}}}let pu=class{constructor(e){this.layout=e}elementCount(e){return e.get("position").indices.length}write(e,i,r,s,n,a){return to(r,s,this.layout,e,i,n,a)}intersect(e,i,r,s,n,a,o){const l=this.layout.createView(e).getField("position",wt);if(l==null)return;const u=me(ro,a,n),c=0,h=l.count/3,v=s.options.normalRequired,_=(d,b,$)=>o(d,$,b);Fa(n,u,c,h,l.typedBuffer,l.typedBufferStride,v,_)}};const ro=g();let j=class{constructor(e,i,r,s,n=null){if(this.name=e,this.type=i,this.arraySize=n,this.bind={0:null,1:null,2:null},s)switch(r){case void 0:break;case 0:this.bind[0]=s;break;case 1:this.bind[1]=s;break;case 2:this.bind[2]=s}}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},so=class extends j{constructor(e,i,r){super(e,"float",0,(s,n)=>s.setUniform1f(e,i(n),r))}},Te=class extends j{constructor(e,i,r){super(e,"vec3",2,(s,n,a,o)=>s.setUniform3fv(e,i(n,a,o),r))}},xe=class extends j{constructor(e,i,r){super(e,"vec3",1,(s,n,a)=>s.setUniform3fv(e,i(n,a),r))}},no=class extends j{constructor(e,i,r){super(e,"mat3",1,(s,n,a)=>s.setUniformMatrix3fv(e,i(n,a),r))}},$u=class extends j{constructor(e,i,r){super(e,"mat4",1,(s,n,a)=>s.setUniformMatrix4fv(e,i(n,a),r))}},wu=class{constructor(e,i){this._module=e,this._load=i}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},Ki=class{constructor(e,i,r){this._context=e,this.locations=r,this._textures=new Map,this.source=ii()?i:null,i.attributeNames.forEach(s=>{r.has(s)||console.error(`Missing VertexAttributeLocation for ${s} used in shader`)}),this._glProgram=e.programCache.acquire(i.generate("vertex",!0),i.generate("fragment",!0),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bind=i.generateBind(this),this.bindPass=i.generateBindPass(this),this.bindDraw=i.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,i){this._glProgram.setUniform1i(e,i?1:0)}setUniform1i(e,i){this._glProgram.setUniform1i(e,i)}setUniform1f(e,i,r){this._glProgram.setUniform1f(e,i,r)}setUniform2fv(e,i,r){this._glProgram.setUniform2fv(e,i,r)}setUniform3fv(e,i,r){this._glProgram.setUniform3fv(e,i,r)}setUniform4fv(e,i,r){this._glProgram.setUniform4fv(e,i,r)}setUniformMatrix3fv(e,i,r){this._glProgram.setUniformMatrix3fv(e,i,!1,r)}setUniformMatrix4fv(e,i,r){this._glProgram.setUniformMatrix4fv(e,i,!1,r)}setUniformMatrices4fv(e,i,r){this._glProgram.setUniformMatrices4fv(e,i,!1,r)}setUniform1fv(e,i,r){this._glProgram.setUniform1fv(e,i,r)}setUniform1iv(e,i){this._glProgram.setUniform1iv(e,i)}setUniform2iv(e,i){this._glProgram.setUniform2iv(e,i)}setUniform3iv(e,i){this._glProgram.setUniform3iv(e,i)}setUniform4iv(e,i){this._glProgram.setUniform4iv(e,i)}assertCompatibleVertexAttributeLocations(e,i){let r=e.locations;if(i){const s=new Map(r);i.forEach((n,a)=>s.set(a,r.size+n)),r=s}r.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${r}, ${this.locations}`),this.locations.forEach((s,n)=>{r.get(n)!==s&&console.error(`VertexAttributeLocations are incompatible: Program has ${n} at position ${s}, VAO has it at position ${r.get(n)}.`)})}stop(){this._textures.clear()}bindTexture(e,i){i?.glName||(ii()&&console.error(`Texture sampler ${e} has no given Texture in ${new Error().stack} `),i=this._context.emptyTexture);const r=this._ensureTextureUnit(e,i);this._context.useProgram(this),this.setUniform1i(e,r.unit),this._context.bindTexture(i,r.unit)}_ensureTextureUnit(e,i){let r=this._textures.get(e);return r==null?(r={texture:i,unit:this._textures.size},this._textures.set(e,r)):r.texture=i,r}};const ao=()=>vi.getLogger("esri.views.3d.webgl.ShaderTechnique");let Tu=class{constructor(e,i,r,s){this.primitiveType=Es.TRIANGLES,this.key=i.key,this._program=new Ki(e.rctx,r.get().build(i),s),this._pipeline=this.initializePipeline(i),this.reload=async n=>{n&&await r.reload(),this.key.equals(i.key)||ao().warn("Configuration was changed after construction, cannot reload shader.",r),zi(this._program),this._program=new Ki(e.rctx,r.get().build(i),s),this._pipeline=this.initializePipeline(i)}}destroy(){this._program=zi(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,i){return this._pipeline}initializePipeline(e){return bn({blending:Mr,colorWrite:wn})}};function Pu(t,e){return xa(t)?{buffers:[Is]}:e??null}function oo(){return!!Rs("enable-feature:objectAndLayerId-rendering")}const zu={func:513},Au={func:519},Ou={mask:255},Eu={mask:0},Iu={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:0}},Ru={function:{func:519,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7681}},Fu={function:{func:514,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}},Du={function:{func:517,ref:2,mask:2},operation:{fail:7680,zFail:7680,zPass:7680}};function Lu(t,e){co(t,e,new Te("slicePlaneOrigin",(i,r)=>Kr(e,i,r)),new Te("slicePlaneBasis1",(i,r)=>Et(e,i,r,r.slicePlane?.basis1)),new Te("slicePlaneBasis2",(i,r)=>Et(e,i,r,r.slicePlane?.basis2)))}function Vu(t,e){Wr(t,e,new Te("slicePlaneOrigin",(i,r)=>Kr(e,i,r)),new Te("slicePlaneBasis1",(i,r)=>Et(e,i,r,r.slicePlane?.basis1)),new Te("slicePlaneBasis2",(i,r)=>Et(e,i,r,r.slicePlane?.basis2)))}const lo=m`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
bool rejectBySlice(vec3 pos) {
return sliceByPlane(pos);
}`;function Wr(t,e,...i){e.hasSlicePlane?(t.uniforms.add(...i),t.code.add(lo)):t.code.add("bool rejectBySlice(vec3 pos) { return false; }")}function co(t,e,...i){Wr(t,e,...i),e.hasSlicePlane?t.code.add(`
    void discardBySlice(vec3 pos) {
      if (sliceByPlane(pos)) {
        discard;
      }
    }

    vec4 applySliceOutline(vec4 color, vec3 pos) {
      SliceFactors factors = calculateSliceFactors(pos);

      factors.front /= 2.0 * fwidth(factors.front);
      factors.side0 /= 2.0 * fwidth(factors.side0);
      factors.side1 /= 2.0 * fwidth(factors.side1);
      factors.side2 /= 2.0 * fwidth(factors.side2);
      factors.side3 /= 2.0 * fwidth(factors.side3);

      // return after calling fwidth, to avoid aliasing caused by discontinuities in the input to fwidth
      if (sliceByFactors(factors)) {
        return color;
      }

      float outlineFactor = (1.0 - step(0.5, factors.front))
        * (1.0 - step(0.5, factors.side0))
        * (1.0 - step(0.5, factors.side1))
        * (1.0 - step(0.5, factors.side2))
        * (1.0 - step(0.5, factors.side3));

      return mix(color, vec4(vec3(0.0), color.a), outlineFactor * 0.3);
    }

    vec4 applySlice(vec4 color, vec3 pos) {
      return sliceEnabled() ? applySliceOutline(color, pos) : color;
    }
  `):t.code.add(m`void discardBySlice(vec3 pos) { }
vec4 applySlice(vec4 color, vec3 pos) { return color; }`)}function Gr(t,e,i){return t.instancedDoublePrecision?k(uo,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):e.slicePlaneLocalOrigin}function Xr(t,e){return t!=null?Me(It,e.origin,t):e.origin}function Yr(t,e,i){return t.hasSliceTranslatedView?e!=null?Pt(ho,i.camera.viewMatrix,e):i.camera.viewMatrix:null}function Kr(t,e,i){if(i.slicePlane==null)return it;const r=Gr(t,e,i),s=Xr(r,i.slicePlane),n=Yr(t,r,i);return n!=null?ge(It,s,n):s}function Et(t,e,i,r){if(r==null||i.slicePlane==null)return it;const s=Gr(t,e,i),n=Xr(s,i.slicePlane),a=Yr(t,s,i);return a!=null?(ae(Ye,r,n),ge(It,n,a),ge(Ye,Ye,a),Me(Ye,Ye,It)):r}const uo=g(),It=g(),Ye=g(),ho=X();let bi=class extends j{constructor(e,i,r){super(e,"vec2",0,(s,n)=>s.setUniform2fv(e,i(n),r))}};function Nu(t){t.vertex.uniforms.add(new bi("nearFar",e=>e.camera.nearFar))}function fo(t){t.vertex.code.add(m`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function Bu(t){fo(t),t.vertex.code.add(m`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),t.vertex.code.add(m`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}function Lt(t){t.code.add(m`struct MaskedColor {
vec4 color;
bvec4 mask;
};`)}function Hu(t){t.include(Lt),t.code.add(m`
    MaskedColor createMaskedFromUInt8NaNColor(vec4 color) {
      return MaskedColor(color * ${m.float(1/254)}, equal(color, vec4(255)));
    }
  `)}function po(t){t.include(Lt),t.code.add(m`vec4 maskedColorSelectOrOne(MaskedColor color) {
return vec4(
color.mask.r ? 1.0 : color.color.r,
color.mask.g ? 1.0 : color.color.g,
color.mask.b ? 1.0 : color.color.b,
color.mask.a ? 1.0 : color.color.a
);
}
MaskedColor multiplyMaskedColors(MaskedColor color1, MaskedColor color2) {
vec4 masked1 = maskedColorSelectOrOne(color1);
vec4 masked2 = maskedColorSelectOrOne(color2);
return MaskedColor(masked1 * masked2, bvec4(ivec4(color1.mask) & ivec4(color2.mask)));
}`)}function vo(t){t.include(Lt),t.code.add(m`MaskedColor createMaskedFromNaNColor(vec4 color) {
return MaskedColor(color, isnan(color));
}`)}let mo=class extends j{constructor(e,i,r){super(e,"vec3",0,(s,n)=>s.setUniform3fv(e,i(n),r))}},St=class extends j{constructor(e,i,r){super(e,"mat4",0,(s,n)=>s.setUniformMatrix4fv(e,i(n),r))}},go=class extends j{constructor(e,i,r){super(e,"mat4",2,(s,n,a)=>s.setUniformMatrix4fv(e,i(n,a),r))}};function _o(t,e){e.instancedDoublePrecision?t.constants.add("cameraPosition","vec3",it):t.uniforms.add(new Te("cameraPosition",(i,r)=>k(Zr,r.camera.viewInverseTransposeMatrix[3]-i.origin[0],r.camera.viewInverseTransposeMatrix[7]-i.origin[1],r.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function Wu(t,e){if(!e.instancedDoublePrecision)return void t.uniforms.add(new St("proj",r=>r.camera.projectionMatrix),new go("view",(r,s)=>Pt(Zi,s.camera.viewMatrix,r.origin)),new Te("localOrigin",r=>r.origin));const i=({camera:r})=>k(Zr,r.viewInverseTransposeMatrix[3],r.viewInverseTransposeMatrix[7],r.viewInverseTransposeMatrix[11]);t.uniforms.add(new St("proj",r=>r.camera.projectionMatrix),new St("view",r=>Pt(Zi,r.camera.viewMatrix,i(r))),new mo("localOrigin",r=>i(r)))}const Zi=X(),Zr=g();function Gu(t){t.uniforms.add(new St("viewNormal",e=>e.camera.viewInverseTransposeMatrix))}function Xu(t){t.uniforms.add(new so("pixelRatio",e=>e.camera.pixelRatio/e.overlayStretch))}function Yu(t,e,i){for(let r=0;r<i;++r)e[2*r]=t[r],e[2*r+1]=t[r]-e[2*r]}function Ku(t,e){const i=t.length;for(let r=0;r<i;++r)We[0]=t[r],e[r]=We[0];return e}function Zu(t,e){const i=t.length;for(let r=0;r<i;++r)We[0]=t[r],We[1]=t[r]-We[0],e[r]=We[1];return e}const We=new Float32Array(2);let Qu=class extends j{constructor(e,i){super(e,"int",1,(r,s,n)=>r.setUniform1i(e,i(s,n)))}};function yo(t,e){switch(e.textureCoordinateType){case 1:return t.attributes.add("uv0","vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(m`void forwardTextureCoordinates() { vuv0 = uv0; }`);case 2:return t.attributes.add("uv0","vec2"),t.attributes.add("uvRegion","vec4"),t.varyings.add("vuv0","vec2"),t.varyings.add("vuvRegion","vec4"),void t.vertex.code.add(m`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:Fs(e.textureCoordinateType);case 0:return void t.vertex.code.add(m`void forwardTextureCoordinates() {}`);case 3:return}}function eh(t,e){e.hasVertexColors?(t.attributes.add("color","vec4"),t.varyings.add("vColor","vec4"),t.vertex.code.add(m`void forwardVertexColor() { vColor = color; }`),t.vertex.code.add(m`
      void forwardNormalizedVertexColor() { vColor = color * ${m.float(1/255)}; }
    `)):t.vertex.code.add(m`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function xo(t){t.vertex.code.add(m`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),t.vertex.code.add(m`vec3 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec3 params) {
return vec3(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z
);
}`),t.vertex.code.add(m`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec3 factor) {
return size * clamp(mix(factor.x, 1.0, factor.y), factor.z, 1.0);
}`),t.vertex.code.add(m`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),t.vertex.code.add(m`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec3 factor) {
return size * clamp(mix(factor.x, 1.0, factor.y), factor.z, 1.0);
}`),t.vertex.code.add(m`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec3 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function th(t){t.uniforms.add(new xe("screenSizePerspective",e=>Qr(e.screenSizePerspective,e.screenSizePerspectiveMinPixelReferenceSize)))}function $o(t){t.uniforms.add(new xe("screenSizePerspectiveAlignment",e=>Qr(e.screenSizePerspectiveAlignment||e.screenSizePerspective,e.screenSizePerspectiveAlignment?null:e.screenSizePerspectiveMinPixelReferenceSize)))}function Qr(t,e){const i=e!=null&&t!=null?Math.min(t.minPixelSize/e,1):0;return t?k(Qi,t.divisor,t.offset,i):k(Qi,0,0,0)}const Qi=g();let Jr=class extends j{constructor(e,i,r){super(e,"vec4",1,(s,n,a)=>s.setUniform4fv(e,i(n,a),r))}},rh=class{constructor(e){this.screenLength=Ds(e.screenLength),this.minWorldLength=e.minWorldLength??0,this.maxWorldLength=e.maxWorldLength??1/0}};function nh(t,e){const i=t.vertex;e.hasVerticalOffset?(wo(i),e.hasScreenSizePerspective&&(t.include(xo),$o(i),_o(t.vertex,e)),i.code.add(m`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${e.spherical?m`vec3 worldNormal = normalize(worldPos + localOrigin);`:m`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${e.hasScreenSizePerspective?m`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:m`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):i.code.add(m`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const bo=Fe();function wo(t){t.uniforms.add(new Jr("verticalOffset",(e,i)=>{const{minWorldLength:r,maxWorldLength:s,screenLength:n}=e.verticalOffset,a=Math.tan(.5*i.camera.fovY)/(.5*i.camera.fullViewport[3]),o=i.camera.pixelRatio||1;return zt(bo,n*o,a,r,s)}))}function ah(t,e){if(e.output!==10)return t.vertex.code.add(m`void forwardObjectAndLayerIdColor() {}`),void t.fragment.code.add(m`void outputObjectAndLayerIdColor() {}`);const i=e.instanced;t.varyings.add("objectAndLayerIdColorVarying","vec4");const r=i?"instanceOlidColor":"olidColor";t.attributes.add(r,"vec4"),t.vertex.code.add(m`
    void forwardObjectAndLayerIdColor() {
      objectAndLayerIdColorVarying = ${r} * 0.003921568627451;
    }`),t.fragment.code.add(m`void outputObjectAndLayerIdColor() {
fragColor = objectAndLayerIdColorVarying;
}`)}function So(t){const{fragment:e}=t;e.code.add(m`uint readChannelBits(uint channel, int highlightLevel) {
int llc = (highlightLevel & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(uvec2 texel, int highlightLevel) {
int lic = (highlightLevel >> 2) & 1;
return texel[lic];
}
uint readLevelBits(uvec2 texel, int highlightLevel) {
return readChannelBits(readChannel(texel, highlightLevel), highlightLevel);
}`)}let Mo=class extends j{constructor(e,i){super(e,"ivec2",0,(r,s)=>r.setUniform2iv(e,i(s)))}},To=class extends j{constructor(e,i){super(e,"int",0,(r,s)=>r.setUniform1i(e,i(s)))}},es=class extends j{constructor(e,i){super(e,"sampler2D",0,(r,s)=>r.bindTexture(e,i(s)))}},Co=class extends j{constructor(e,i){super(e,"usampler2D",0,(r,s)=>r.bindTexture(e,i(s)))}};function Po(t,e){const{fragment:i}=t,{output:r,draped:s,hasHighlightMixTexture:n}=e;r===9?(i.uniforms.add(new To("highlightLevel",a=>a.highlightLevel??0),new Mo("highlightMixOrigin",a=>a.highlightMixOrigin)),t.outputs.add("fragHighlight","uvec2",0),t.include(So),n?i.uniforms.add(new Co("highlightMixTexture",a=>a.highlightMixTexture)).code.add(m`uvec2 getAccumulatedHighlight() {
return texelFetch(highlightMixTexture, ivec2(gl_FragCoord.xy) - highlightMixOrigin, 0).rg;
}
void outputHighlight(bool occluded) {
if (highlightLevel == 0) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
} else {
int ll = (highlightLevel & 3) << 1;
int li = (highlightLevel >> 2) & 3;
uint bits;
if (occluded) {
bits = 3u << ll;
} else {
bits = 1u << ll;
}
uvec2 combinedHighlight = getAccumulatedHighlight();
combinedHighlight[li] |= bits;
fragHighlight = combinedHighlight;
}
}`):i.code.add(m`void outputHighlight(bool occluded) {
uint bits = occluded ? 3u : 1u;
fragHighlight = uvec2(bits, 0);
}`),s?i.code.add(m`bool isHighlightOccluded() {
return false;
}`):i.uniforms.add(new es("depthTexture",a=>a.mainDepth)).code.add(m`bool isHighlightOccluded() {
float sceneDepth = texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x;
return gl_FragCoord.z > sceneDepth + 5e-7;
}`),i.code.add(m`void calculateOcclusionAndOutputHighlight() {
outputHighlight(isHighlightOccluded());
}`)):i.code.add(m`void calculateOcclusionAndOutputHighlight() {}`)}let zo=class extends j{constructor(e,i,r,s){super(e,"vec4",1,(n,a,o)=>n.setUniform4fv(e,i(a,o),s),r)}},Ao=class extends j{constructor(e,i,r,s){super(e,"float",1,(n,a,o)=>n.setUniform1fv(e,i(a,o),s),r)}},wi=class{constructor(e){this.field=e}},Oo=class extends wi{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[0,0,0],this.fallback=[0,0,0]}},Ji=class extends wi{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0],this.fallback=[0,0,0,0]}};class Eo extends wi{constructor(e,i=0){super(e),this.fallback=i,this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}}class Io{}function Ke(t){return t!=null}function Ro(t,e,i,r=X()){const s=t||0,n=e||0,a=i||0;return s!==0&&js(r,r,-s/180*Math.PI),n!==0&&fr(r,r,n/180*Math.PI),a!==0&&Us(r,r,a/180*Math.PI),r}function Pe(t,e,i,r,s){const n=t.minSize,a=t.maxSize;if(t.useSymbolValue){const o=r.symbolSize[i];return e.minSize[i]=o,e.maxSize[i]=o,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0}if(Ke(t.field))return Ke(t.stops)?t.stops.length===2&&Ne(t.stops[0].size)&&Ne(t.stops[1].size)?(er(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,i),e.type[i]=1,!0):!1:Ne(n)&&Ne(a)&&Ke(t.minDataValue)&&Ke(t.maxDataValue)?(er(n,a,t.minDataValue,t.maxDataValue,e,i),e.type[i]=1,!0):t.valueUnit==="unknown"?!1:Ai[t.valueUnit]!=null?(e.minSize[i]=-1/0,e.maxSize[i]=1/0,e.offset[i]=0,e.factor[i]=1/Ai[t.valueUnit],e.type[i]=1,!0):!1;if(!Ke(t.field)){if(t.stops?.[0]&&Ne(t.stops[0].size))return e.minSize[i]=t.stops[0].size,e.maxSize[i]=t.stops[0].size,e.offset[i]=e.minSize[i],e.factor[i]=0,e.type[i]=1,!0;if(Ne(n))return e.minSize[i]=n,e.maxSize[i]=n,e.offset[i]=n,e.factor[i]=0,e.type[i]=1,!0}return!1}function er(t,e,i,r,s,n){const a=Math.abs(r-i)>0?(e-t)/(r-i):0;s.minSize[n]=a>0?t:e,s.maxSize[n]=a>0?e:t,s.offset[n]=t-i*a,s.factor[n]=a}function Fo(t,e,i,r){if(t.normalizationField||t.valueRepresentation||!Hs(t.field))return null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return null}else e.size.field=t.field}else e.size=new Oo(t.field),U(e.size.fallback,i.fallbackSize);let s;switch(t.axis){case"width":return s=Pe(t,e.size,0,i),s?e:null;case"height":return s=Pe(t,e.size,2,i),s?e:null;case"depth":return s=Pe(t,e.size,1,i),s?e:null;case"width-and-depth":return s=Pe(t,e.size,0,i),s&&Pe(t,e.size,1,i),s?e:null;case null:case void 0:case"all":return s=Pe(t,e.size,0,i),s=s&&Pe(t,e.size,1,i),s=s&&Pe(t,e.size,2,i),s?e:null;default:return`${t.axis}`,null}}function Do(t,e,i){for(let s=0;s<3;++s){let n=e.unitInMeters;t.type[s]===1&&(n*=e.modelSize[s],t.type[s]=2),t.minSize[s]=t.minSize[s]/n,t.maxSize[s]=t.maxSize[s]/n,t.offset[s]=t.offset[s]/n,t.factor[s]=t.factor[s]/n}let r;if(t.type[0]!==0)r=0;else if(t.type[1]!==0)r=1;else{if(t.type[2]===0)return!1;r=2}for(let s=0;s<3;++s)t.type[s]===0&&(t.minSize[s]=t.minSize[r],t.maxSize[s]=t.maxSize[r],t.offset[s]=t.offset[r],t.factor[s]=t.factor[r],t.type[s]=t.type[r]);return!0}function tr(t,e,i){t[4*e]=i.r/255,t[4*e+1]=i.g/255,t[4*e+2]=i.b/255,t[4*e+3]=i.a}function Lo(t,e,i,r){if(t.normalizationField)return null;if(gi(t.field)){if(!t.stops)return null;{if(t.stops.length>8)return null;e.color=new Ji(t.field);const s=t.stops;for(let n=0;n<8;++n){const a=s[Math.min(n,s.length-1)];e.color.values[n]=a.value,tr(e.color.colors,n,a.color)}Ue(e.color.fallback,i.fallbackColor)}}else{if(!(t.stops&&t.stops.length>=0))return null;{const s=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color=new Ji(null);for(let n=0;n<8;n++)e.color.values[n]=1/0,tr(e.color.colors,n,s);Ue(e.color.fallback,i.fallbackColor)}}return e}function Vo(t,e,i,r){if(t.normalizationField)return null;if(gi(t.field)){if(!t.stops)return null;{if(t.stops.length>8)return null;e.opacity=new Eo(t.field,i.fallbackColor[3]);const s=t.stops;for(let n=0;n<8;++n){const a=s[Math.min(n,s.length-1)];e.opacity.values[n]=a.value,e.opacity.opacityValues[n]=a.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return null;{const s=t.stops&&t.stops.length>=0?t.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0],fallback:i.fallbackColor[3]};for(let n=0;n<8;n++)e.opacity.values[n]=1/0,e.opacity.opacityValues[n]=s}}return e}function qt(t,e,i){const r=i===2&&t.rotationType==="arithmetic";e.offset[i]=r?90:0,e.factor[i]=r?-1:1,e.type[i]=1}function ko(t,e,i){if(!gi(t.field))return null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return qt(t,e.rotation,0),e;case"roll":return qt(t,e.rotation,1),e;case null:case void 0:case"heading":return qt(t,e.rotation,2),e;default:return`${t.axis}`,null}}class mh{constructor({supports:e,modelSize:i,symbolSize:r,unitInMeters:s,anchor:n,scale:a,rotation:o,fallbackColor:l,fallbackSize:u}){this.supports=e,this.modelSize=i??ot(),this.symbolSize=r??ot(),this.unitInMeters=s??1,this.anchor=n??rt(),this.scale=a??ot(),this.rotation=o??rt(),this.fallbackColor=l??Ls(),this.fallbackSize=u??ot()}}function ts(t,e,i){if(!t)return null;const r=t.reduce((s,n)=>{if(!s)return s;if(n.valueExpression)return null;switch(n.type){case"size":return e.supports.size?Fo(n,s,e,i):s;case"color":return e.supports.color?Lo(n,s,e):s;case"opacity":return e.supports.opacity?Vo(n,s,e):null;case"rotation":return e.supports.rotation?ko(n,s,i):s;default:return null}},new Io);return!(t.length>0&&r)||r.size||r.color||r.opacity||r.rotation?r?.size&&!Do(r.size,e)?null:r:null}class No{constructor(e,i,r){this.visualVariables=e,this.materialParameters=i,this.requiresShaderTransformation=r}}function gh(t,e){if(!t||oo()||Un.TESTS_DISABLE_FAST_UPDATES)return null;const i=ts(t.visualVariables,e);return i?new No(i,rs(i,e),!!i.size):null}function _h(t,e,i){if(!e||!t)return!1;const r=t.visualVariables,s=ts(e.visualVariables,i);return!!s&&!!(pt(r.size,s.size,"size")&&pt(r.color,s.color,"color")&&pt(r.rotation,s.rotation,"rotation")&&pt(r.opacity,s.opacity,"opacity"))&&(t.visualVariables=s,t.materialParameters=rs(s,i),t.requiresShaderTransformation=!!s.size,!0)}function pt(t,e,i){if(!!t!=!!e||t&&t.field!==e?.field)return!1;if(t&&i==="rotation"){const r=t,s=e;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}class is extends Dt{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}get hasVVSize(){return!!this.vvSize}get hasVVColor(){return!!this.vvColor}get hasVVOpacity(){return!!this.vvOpacity}}function rs(t,e){const i=new is(t);return i.vvSize&&(i.vvSymbolAnchor=e.anchor,Ns(tt),Ro(e.rotation[2],e.rotation[0],e.rotation[1],tt),i.vvSymbolRotationMatrix=i.vvSymbolRotationMatrix||ur(),Bs(i.vvSymbolRotationMatrix,tt)),i}function yh(t,e,i){if(!t.vvSize)return i;Ge(ze,i);const r=t.vvSymbolRotationMatrix;return Vs(tt,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),Ct(ze,ze,tt),Bo(ir,t,e),ks(ze,ze,ir),Pt(ze,ze,t.vvSymbolAnchor),ze}function Bo(t,e,i){if(!e.vvSize)return k(t,1,1,1),t;if(Number.isNaN(i[0]))return U(t,e.vvSize.fallback);for(let r=0;r<3;++r){const s=e.vvSize.offset[r]+i[0]*e.vvSize.factor[r];t[r]=nt(s,e.vvSize.minSize[r],e.vvSize.maxSize[r])}return t}function xh(t,e){const i=t==null?0:e.attributes[t];return typeof i=="number"&&isFinite(i)?i:NaN}const ze=X(),ir=g(),tt=X();let $h=class extends is{constructor(){super(...arguments),this.renderOccluded=1,this.isDecoration=!1}};const Wt=8;function wh(t,e){const{vertex:i,attributes:r}=t;e.hasVVInstancing&&(e.hasVVSize||e.hasVVColor)&&r.add("instanceFeatureAttribute","vec4"),e.hasVVSize?(i.uniforms.add(new xe("vvSizeMinSize",s=>s.vvSize.minSize)),i.uniforms.add(new xe("vvSizeMaxSize",s=>s.vvSize.maxSize)),i.uniforms.add(new xe("vvSizeOffset",s=>s.vvSize.offset)),i.uniforms.add(new xe("vvSizeFactor",s=>s.vvSize.factor)),i.uniforms.add(new xe("vvSizeFallback",s=>s.vvSize.fallback)),i.uniforms.add(new no("vvSymbolRotationMatrix",s=>s.vvSymbolRotationMatrix)),i.uniforms.add(new xe("vvSymbolAnchor",s=>s.vvSymbolAnchor)),i.code.add(m`vec3 vvScale(vec4 _featureAttribute) {
if (isnan(_featureAttribute.x)) {
return vvSizeFallback;
}
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(m`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 scale = max(vvScale(_featureAttribute), eps);
        return vec4(vvSymbolRotationMatrix * _normal / scale, 1.0);
      }

      ${e.hasVVInstancing?m`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(m`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vertex.include(Lt),e.hasVVColor?(i.constants.add("vvColorNumber","int",Wt),i.uniforms.add(new Ao("vvColorValues",s=>s.vvColor.values,Wt),new zo("vvColorColors",s=>s.vvColor.colors,Wt),new Jr("vvColorFallback",s=>s.vvColor.fallback,{supportsNaN:!0})),e.hasVVInstancing&&(t.vertex.include(po),t.vertex.include(vo)),i.code.add(m`
      vec4 interpolateVVColor(float value) {
        if (isnan(value)) {
          return vvColorFallback;
        }

        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${e.hasVVInstancing?m`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return multiplyMaskedColors(color, createMaskedFromNaNColor(vvColor()));
            }
            `:m`
            vec4 vvColor() {
              return vec4(1.0);
            }

            MaskedColor applyVVColor(MaskedColor color) {
              return color;
            }
            `}
    `)):i.code.add(m`vec4 vvColor() {
return vec4(1.0);
}
MaskedColor applyVVColor(MaskedColor color) {
return color;
}`)}let Ho=class extends j{constructor(e,i,r){super(e,"float",2,(s,n,a)=>s.setUniform1f(e,i(n,a),r))}},jo=class extends j{constructor(e,i,r){super(e,"float",1,(s,n,a)=>s.setUniform1f(e,i(n,a),r))}};const Uo=1/255.5;let qo=class extends j{constructor(e,i){super(e,"sampler2D",1,(r,s,n)=>r.bindTexture(e,i(s,n)))}};function Wo(t){t.fragment.code.add(m`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Go(t,e){const{textureCoordinateType:i}=e;if(i===0||i===3)return;t.include(yo,e);const r=i===2;r&&t.include(Wo),t.fragment.code.add(m`
    vec4 textureLookup(sampler2D tex, vec2 uv) {
      return ${r?"textureAtlasLookup(tex, uv, vuvRegion)":"texture(tex, uv)"};
    }
  `)}let Ch=class extends j{constructor(e,i,r){super(e,"vec2",1,(s,n,a)=>s.setUniform2fv(e,i(n,a),r))}},Xo=class extends j{constructor(e,i){super(e,"sampler2D",2,(r,s,n)=>r.bindTexture(e,i(s,n)))}};function Yo(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}function Ko(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}function Zo(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function Qo(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}var ci;let P=ci=class extends fi{constructor(t){super(t),this._ray=Ar(),this._viewport=Oi(0,0,1,1),this._padding=Oi(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=pr(1,1e3),this._viewDirty=!0,this._viewMatrix=X(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=X(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=X(),this._frustumDirty=!0,this._frustum=Tr(),this._fullViewport=Fe(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=g(),this._up=g(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return Me(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){Ge(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),k(g(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),k(g(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),k(g(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=Ei(Fe(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&Ii(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=Ei(Fe(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&Ii(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[3],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[2],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(t){this.width=t-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(t){this.height=t-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){jt(this._padding,t)||(this._viewport[0]+=t[3]-this._padding[3],this._viewport[1]+=t[2]-this._padding[2],this._viewport[2]-=t[1]+t[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=t[0]+t[2]-(this._padding[0]+this._padding[2]),Ue(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Ct(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return bt(X(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||X()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Zo(this._fov,this.width,this.height)}set fovX(t){this._fov=Yo(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Qo(this._fov,this.width,this.height)}set fovY(t){this._fov=Ko(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return vr(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(bt(this._viewInverseTransposeMatrix,this.viewMatrix),ri(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const{near:e,far:i}=this;return 2*e*i/(i+e-t*(i-e))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,a=-r/2+this.column*n,o=a+n,l=-i/2+this.row*s,u=l+s,c=qs(X(),a*(1+2*this._padding[3]/t),o*(1+2*this._padding[1]/t),l*(1+2*this._padding[2]/e),u*(1+2*this._padding[0]/e),this.near,this.far),h=this._get("projectionMatrix");return h&&Ws(h,c)?h:c}copyFrom(t){U(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,Ue(this._viewport,t.viewport),this.notifyChange("_viewport"),Ue(this._padding,t.padding),this.notifyChange("_padding"),Gs(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(Ge(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(Sn(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Ge(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Ue(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up,this.fov=t.fov}clone(){return new ci().copyFrom(this)}equals(t){return Ee(this.eye,t.eye)&&Ee(this.center,t.center)&&Ee(this.up,t.up)&&jt(this._viewport,t.viewport)&&jt(this._padding,t.padding)&&Xs(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||Ri(t.screenPadding,this.screenPadding)>=e||Ri(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;me(q,t.eye,t.center),me(ve,this.eye,this.center);const i=ue(q,ve),r=Fi(q),s=Fi(ve),n=5e-4;return i*i>=(1-1e-10)*r*s&&si(t.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(Rn(this.viewForward,Me(q,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=Ys()){return t[0]=(this.padding[3]+this.width/2)/this.pixelRatio,t[1]=(this.padding[0]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,i=.5){return t[0]=this.padding[3]+this.width*e,t[1]=this.padding[2]+this.height*i,t[2]=.5,t}setGLViewport(t){const e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])}applyProjection(t,e){t!==I&&U(I,t),I[3]=1,lt(I,I,this.projectionMatrix);const i=Math.abs(I[3]);W(I,I,1/i);const r=this.fullViewport;e[0]=te(0,r[0]+r[2],.5+.5*I[0]),e[1]=te(0,r[1]+r[3],.5+.5*I[1]),e[2]=.5*(I[2]+1),e[3]=i}unapplyProjection(t,e){const i=this.fullViewport;I[0]=(t[0]/(i[0]+i[2])*2-1)*t[3],I[1]=(t[1]/(i[1]+i[3])*2-1)*t[3],I[2]=(2*t[2]-1)*t[3],I[3]=t[3],this.inverseProjectionMatrix!=null&&(lt(I,I,this.inverseProjectionMatrix),e[0]=I[0],e[1]=I[1],e[2]=I[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,Gt),this.renderToScreen(Gt,e),e}projectToRenderScreen(t,e){if(I[0]=t[0],I[1]=t[1],I[2]=t[2],I[3]=1,lt(I,I,this.viewProjectionMatrix),I[3]===0)return null;const i=I;W(i,i,1/Math.abs(I[3]));const r=this.fullViewport,s=te(0,r[0]+r[2],.5+.5*i[0]),n=te(0,r[1]+r[3],.5+.5*i[1]);return"x"in e?(e.x=s,e.y=n):(e[0]=s,e[1]=n,e.length>2&&(e[2]=.5*(i[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,Gt),e)}unprojectFromRenderScreen(t,e){if(Ct(vt,this.projectionMatrix,this.viewMatrix),!bt(vt,vt))return null;const i=this.fullViewport;return I[0]=2*(t[0]-i[0])/i[2]-1,I[1]=2*(t[1]-i[1])/i[3]-1,I[2]=2*t[2]-1,I[3]=1,lt(I,I,vt),I[3]===0?null:(e[0]=I[0]/I[3],e[1]=I[1]/I[3],e[2]=I[2]/I[3],e)}constrainWindowSize(t,e,i,r){const s=t*this.pixelRatio,n=e*this.pixelRatio,a=Math.max(s-i/2,0),o=Math.max(this.fullHeight-n-r/2,0),l=-Math.min(s-i/2,0),u=-Math.min(this.fullHeight-n-r/2,0),c=i-l- -Math.min(this.fullWidth-s-i/2,0),h=r-u- -Math.min(n-r/2,0);return[Math.round(a),Math.round(o),Math.round(c),Math.round(h)]}computeUp(t){t===1?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e}renderToScreen(t,e){const i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;e[0]=i,e[1]=r}_computeUpGlobal(){Me(q,this.center,this.eye);const t=Y(this.center);t<1?Ee(this._up,Di)&&(U(this._up,Di),this._markViewDirty(),this.notifyChange("_up")):Math.abs(ue(q,this.center))>.9999*Y(q)*t||(de(ve,q,this.center),de(ve,ve,q),Ce(ve,ve),Ee(this._up,ve)||(U(this._up,ve),this.notifyChange("_up"),this._markViewDirty()))}_computeUpLocal(){mr(q,this.eye,this.center),Math.abs(q[2])<=.9999&&(W(q,q,q[2]),k(q,-q[0],-q[1],1-q[2]),Ce(q,q),Ee(this._up,q)||(U(this._up,q),this.notifyChange("_up"),this._markViewDirty()))}_compareAndSetView(t,e,i=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?Ee(t,e)||(U(e,t),this._markViewDirty(),i.length&&this.notifyChange(i)):vi.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Cr(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Zs(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};f([p()],P.prototype,"_viewport",void 0),f([p()],P.prototype,"_padding",void 0),f([p()],P.prototype,"_fov",void 0),f([p()],P.prototype,"_nearFar",void 0),f([p()],P.prototype,"_viewDirty",void 0),f([p()],P.prototype,"_viewMatrix",void 0),f([p()],P.prototype,"_pixelRatio",void 0),f([p()],P.prototype,"pixelRatio",null),f([p()],P.prototype,"row",void 0),f([p()],P.prototype,"column",void 0),f([p()],P.prototype,"_rows",void 0),f([p()],P.prototype,"rows",null),f([p()],P.prototype,"_columns",void 0),f([p()],P.prototype,"columns",null),f([p()],P.prototype,"eye",null),f([p()],P.prototype,"center",null),f([p()],P.prototype,"_center",void 0),f([p()],P.prototype,"up",null),f([p()],P.prototype,"_up",void 0),f([p()],P.prototype,"viewMatrix",null),f([p({readOnly:!0})],P.prototype,"viewForward",null),f([p({readOnly:!0})],P.prototype,"viewUp",null),f([p({readOnly:!0})],P.prototype,"viewRight",null),f([p({readOnly:!0})],P.prototype,"nearFar",null),f([p()],P.prototype,"near",null),f([p()],P.prototype,"far",null),f([p()],P.prototype,"viewport",null),f([p({readOnly:!0})],P.prototype,"screenViewport",null),f([p({readOnly:!0})],P.prototype,"screenPadding",null),f([p()],P.prototype,"x",null),f([p()],P.prototype,"y",null),f([p()],P.prototype,"width",null),f([p()],P.prototype,"height",null),f([p()],P.prototype,"fullWidth",null),f([p()],P.prototype,"fullHeight",null),f([p({readOnly:!0})],P.prototype,"_aspect",null),f([p()],P.prototype,"padding",null),f([p({readOnly:!0})],P.prototype,"projectionMatrix",null),f([p({readOnly:!0})],P.prototype,"inverseProjectionMatrix",null),f([p()],P.prototype,"fov",null),f([p()],P.prototype,"fovX",null),f([p()],P.prototype,"fovY",null),f([p()],P.prototype,"viewInverseTransposeMatrix",null),f([p({readOnly:!0})],P.prototype,"_projectionMatrixInternal",null),f([p()],P.prototype,"relativeElevation",void 0),P=ci=f([pi("esri.views.3d.webgl.RenderCamera")],P);const Ah=P,I=Fe(),vt=X(),q=g(),ve=g(),Gt=Ks();var Se;let Oh=(Se=class{constructor(e=1/0,i=-1/0){this.near=e,this.far=i}set(e,i){this.near=e,this.far=i}union(e){e!=null&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}},Se.Zero=new Se(0,0),Se.Infinite=new Se,Se);function Jo(t,e){const i=[],r=[];return mt(i,t,e,0),mt(r,i,e,1),mt(i,r,e,2),mt(r,i,e,3),r}function mt(t,e,i,r){const s=el(i,r);if(t.length=0,e.length){s(gt,e[0],e[0])===1&&Ze(t,e[0]);for(let n=0;n<e.length;n++){const a=e[n===e.length-1?0:n+1];switch(s(gt,e[n],a)){case 1:Ze(t,a);break;case 3:Ze(t,Li(gt));break;case 2:Ze(t,Li(gt)),Ze(t,a)}}}}function Ze(t,e){t.length!==0&&Qs(t.at(-1),e)||t.push(e)}function el(t,e){const i=e===0||e===2?0:1,r=t[e],s=e===0||e===1?1:-1,n=i===0?1:0;return(a,o,l)=>{if(o[i]<r&&l[i]<r)return s===1?0:1;if(o[i]>r&&l[i]>r)return s===1?1:0;const u=(l[n]-o[n])/(l[i]-o[i]),c=o[n]+u*(r-o[i]);return a[i]=r,a[n]=c,(o[i]<r?1:-1)*s>0?2:3}}const gt=_i(),tl=g(),_t=g();function ss(){return{direction:g(),up:g()}}function ns(t,e,i,r,s){let n=Ce(tl,t),a=ue(n,r);const o=a>0;a=Math.abs(a),a>.99&&(a=Math.abs(ue(e,r)),a<.99?(U(n,e),o&&W(n,n,-1)):n=null);let l=0;if(n){W(_t,r,ue(r,n)),Me(n,n,_t);const c=ue(n,s)/(Y(n)*Y(s));de(_t,n,s),l=(ue(_t,r)>0?1:-1)*Le(ni(c))}const u=Le(ni(-ue(r,t)/Y(t)));return i?(i.heading=l,i.tilt=u,i):{heading:l,tilt:u}}function as(t,e,i,r){Me(rr,i,e),Nn(r,Ln(e,rr),t)||t===i||U(t,i)}const rr=g(),os=K(0,1,0),ls=K(0,0,1),Qe=X(),_e=g(),ye=g();function cs(t,e,i,r=ss()){const{direction:s,up:n}=r;return Js(Qe,-oe(e)),fr(Qe,Qe,oe(i)),ge(s,ls,Qe),W(s,s,-1),ge(n,os,Qe),r}function il(t,e,i,r){return ns(e,i,r,ls,os)}function rl(t,e,i,r){const s=cs(t,i,r),n=g();return W(n,s.direction,-e),ae(n,n,t),{up:s.up,eye:n,heading:i,tilt:r}}function sl(t){return Le(t)}function nl(t){return oe(t)}function al(t,e,i,r,s){const n=t.renderSpatialReference,a=t.spatialReference??e.spatialReference;return ji(e,_e,n),ji(e,ye,n),_e[0]-=i/2,ye[0]+=i/2,_e[1]-=r/2,ye[1]+=r/2,Hi(_e,n,_e,a),Hi(ye,n,ye,a),s?(s.xmin=_e[0],s.ymin=_e[1],s.xmax=ye[0],s.ymax=ye[1],s.spatialReference=a):s=new gr(_e[0],_e[1],ye[0],ye[1],a),s}function ol(t,e){const i=t.frustum,{renderCoordsHelper:r}=t,s=r.getAltitude(e),n=t.spatialReference,a=t.state.camera.eye,o=[],l=i.planes[5];for(let u=0;u<4;u++){const c=i.lines[u];r.intersectInfiniteManifold(Or(c.origin,c.direction),s,he)||ll(he,i,r,c.endpoint,s),as(he,a,he,l),o.push(pr(he[0],he[1]))}return cl(Jo(o,r.extent),r,n)}function ll(t,e,i,r,s){const n=e.lines[11].direction,a=(s-i.getAltitude(r))/n[2];we(t,r,n,a)}function cl(t,e,i){const r=t.map(s=>(k(he,s[0],s[1],0),e.fromRenderCoords(he,he,i),[he[0],he[1]]));return r.length<=2?new ai({spatialReference:i}):(r.push(r[0].slice()),_r(r)||r.reverse(),new ai({rings:[r],spatialReference:i}))}const he=g();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:il,eyeForCenterWithHeadingTilt:rl,eyeTiltToLookAtTilt:nl,headingTiltToDirectionUp:cs,lookAtTiltToEyeTilt:sl,toArea:ol,toExtent:al},Symbol.toStringTag,{value:"Module"}));var De;let ul=(De=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}constructor(e){this.renderCoordsHelper=e,this.frustum=Tr(),this._points=Mn(),this.lines=new Array(12),this._origin=g(),this._direction=g(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:g(),endpoint:null}}update(e){Cr(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),U(this._origin,e.eye),U(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let i=0;i<this._points.length;i++)U(this._points[i],e[i]);Tn(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return Cn(this.frustum,e)}intersectsRay(e){return Pn(this.frustum,e)}intersectsLineSegment(e,i){return zn(this.frustum,e,i)}intersectsPoint(e){return An(this.frustum,e)}_updateLines(){const e=this._points;for(let i=0;i<4;i++){const r=i+4;Xt(this.lines[i],e[i],e[r]),Xt(this.lines[i+4],e[i],i===3?e[0]:e[i+1]),Xt(this.lines[i+8],e[r],i===3?e[4]:e[r+1])}}},De.planePointIndices=On,De.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]],De);function Xt(t,e,i){t.origin=e,t.endpoint=i,mr(t.direction,e,i)}const Yt=K(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),Kt=3,Zt=K(Kt*parseFloat(65e-8.toFixed(6)),Kt*parseFloat(1881e-9.toFixed(6)),Kt*parseFloat(85e-9.toFixed(6)));K(parseFloat(Number(Yt[0]+Zt[0]).toFixed(6)),parseFloat(Number(Yt[1]+Zt[1]).toFixed(6)),parseFloat(Number(Yt[2]+Zt[2]).toFixed(6)));const hl=2;Ft();Ar();function dl(t,e,i){t.worldUpAtPosition(e,sr),Me(Qt,i,e);const r=Y(Qt);return r===0?0:ni(ue(Qt,sr)/r)}const sr=g(),Qt=g();function fl(t,e,i){const r=e/i,s=oe(t),n=Math.sin(r/2),a=Math.cos(s),o=2*Rt(Math.sqrt(n*n/(a*a)));return Le(o)}const us=K(0,0,1),hs=Ce(g(),K(1,1,1)),Je=X(),Ae=g(),Be=g();function ds(t,e,i,r=ss()){de(Ae,t,us),ue(Ae,Ae)===0&&de(Ae,t,hs),an(Je,-oe(e),t),on(Je,Je,-oe(i),Ae);const{up:s,direction:n}=r;return de(s,Ae,t),Ce(s,s),ge(s,s,Je),Ce(n,t),yr(n,n),ge(n,n,Je),r}function pl(t,e,i,r){const s=Ae,n=Be;return Ce(s,t),de(Be,s,us),ue(Be,Be)===0&&de(Be,s,hs),de(n,Be,s),ns(e,i,r,s,n)}function vl(t,e,i,r){const s={eye:g(),up:null,tilt:r,heading:i},n=Ae;n[0]=t[0],n[1]=t[2],n[2]=-t[1];const a=e,o=oe(i),l=oe(r),u=Math.sin(o),c=Math.cos(o),h=Math.sin(l),v=Math.cos(l),_=Y(n);let d;if(Math.abs(l)<1e-8)d=a+_;else{const V=_/h,N=Rt(a/V),Z=Math.PI-l-N;d=V*Math.sin(Z)}const b=v*a,$=a*a*(h*h),z=c*c*$,A=d-b,C=A*A,O=z*(z+C-n[1]*n[1]);if(O<0)return W(s.eye,n,d/_),s.tilt=0,yt(s,t);const R=Math.sqrt(O),D=n[1]*A,T=z+C;let w;if(w=c>0?-R+D:R+D,Math.abs(T)<1e-8)return _<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=a):W(s.eye,n,d/_),s.tilt=0,Jt(s.eye),yt(s,t);s.eye[1]=w/T;const x=u*u*$,E=h*a,y=c*E*s.eye[1],S=s.eye[1]*s.eye[1],M=1-S,F=Math.sqrt(M),L=z*S+x-2*y*F*A+M*C;return Math.abs(L)<1e-8?(W(s.eye,n,d/_),s.tilt=0,Jt(s.eye),yt(s,t)):(s.eye[0]=(M*(d*n[0]-b*n[0])-E*F*(n[0]*s.eye[1]*c+n[2]*u))/L,s.eye[2]=(M*(d*n[2]-b*n[2])-E*F*(n[2]*s.eye[1]*c-n[0]*u))/L,W(s.eye,s.eye,d),Jt(s.eye),yt(s,t))}function Jt(t){const e=t[1];t[1]=-t[2],t[2]=e}function yt(t,e){const i=ds(e,t.heading,t.tilt);return t.up=i.up,t}function ml(t,e,i){const r=Y(e),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-t)),n=Rt(i/(s/Math.sin(t)));return Le(t-n)}function gl(t,e,i){const r=oe(t),s=Y(e);return Rt(i/(s/Math.sin(r)))+r}function _l(t,e,i,r,s){let n,a,o,l;const u=e.latitude,c=en(t.spatialReference).radius,h=e.longitude,v=fl(u,i,c)/2;n=h-v,a=h+v;const _=oe(u),d=(1+Math.sin(_))/(1-Math.sin(_)),b=(d+1)*Math.tan(r/c/2),$=b*b;function z(C){const O=Math.PI/2;return(C=ln.normalize(C,-O))>O&&(C=Math.PI-C),C}if(o=1.5*Math.PI-2*Math.atan(.5*(b+Math.sqrt(4*d+$))),l=o+r/c,o=z(o),l=z(l),l<o){const C=l;l=o,o=C}if(o=Math.max(Le(o),-90),l=Math.min(Le(l),90),a=tn.monotonic(n,a),a-n>180){const C=(a-n-180)/2;n+=C,a-=C}const A=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:rn.WGS84;return s?(s.xmin=n,s.ymin=o,s.xmax=a,s.ymax=l,s.spatialReference=A):s=new gr(n,o,a,l,A),t.spatialReference&&t.spatialReference.isWebMercator&&sn(s,!1,s),s}function yl(t,e){const{renderCoordsHelper:i}=t,r=t.state.camera.clone(),s=new ul(i);r.near=hl,s.update(r);const n=i.getAltitude(e),a=t.spatialReference,o=i.referenceEllipsoid.radius,l=r.eye,u=1+vr(l,e)/(o+n),c=Math.sqrt(u*u-1),{minCurvature:h,maxCurvature:v,minSamples:_,maxSamples:d}=wl,b=bl(t),$=nt((c-h)/(v-h),0,1),z=Math.round(te(_,d,$)),A=r.aboveGround,C=s.planes[5],O=[],R=Ui(it,Sl,qi()),D=Ui(it,Ml,qi());zt(ei,0,0,0,0);const T=x=>{};for(let x=0;x<4;x++){const E=x===1&&!A||x===3&&A?1-b:0,y=x===1&&A||x===3&&!A?b:1,S=s.lines[x],M=s.lines[x===3?0:x+1];for(let F=0;F<z;F++){const L=F/z,V=F===0?0:te(E,y,x===1?1-(1-L)**2:x===3?L**2:L),N=Tt(Cl,S.origin,M.origin,V),Z=Bn(S.direction,M.direction,V,Tl);i.intersectManifoldClosestSilhouette(Or(N,Z),n,Q),as(Q,l,Q,C),O.push(cr(Q)),O.length!==0&&T(si(O.at(-1),Q));const ie=(Wi(R,Q)?1:0)|(Wi(D,Q)?2:0);ei[ie]=1}}O.length>2&&T(si(O[0],O.at(-1)));const w=xl(nn(ei)>1?$l(fs(O,R),D):[O],i,a);return new ai({rings:w,spatialReference:a})}function xl(t,e,i){const r=2*xr();return t.map(s=>{const n=[];let a=!1;for(const o of s)e.fromRenderCoords(o,Q,i),Math.abs(o[0])<r&&Math.abs(o[1])<r?(n.push([null,Q[1]]),n.push([null,Q[1]]),a=!0):n.push([Q[0],Q[1]]);if(a)for(let o=0;o<n.length;o++){const l=n[o];if(l[0]!=null)continue;const u=n[o+1],c=n.at(o===0?-1:o-1);l[0]=c[0],o++;const h=n.at(o===n.length-1?0:o+1);u[0]=h[0]}return n.push(n[0]),_r(n)||n.reverse(),n})}function $l(t,e){const i=[];for(const r of t)i.push(...fs(r,e));return i}function fs(t,e){const i=[],r=[],s=xr();for(let a=0;a<t.length;a++){const o=t[a],l=a===t.length-1?t[0]:t[a+1],u=kn(o,l,Pl),c=Hn(e,u.origin,u.vector,0,Q);switch(c){case 2:i.push(o);break;case 3:r.push(o);break;case 0:case 1:{const[h,v,_]=c===0?[1,i,r]:[-1,r,i],d=jn(e),b=we(g(),Q,d,h*s),$=we(g(),Q,d,h*-s);v.push(o),v.push(b),_.push($)}}}const n=[];return i.length&&n.push(i),r.length&&n.push(r),n}function bl(t){const{renderCoordsHelper:e,state:{camera:i}}=t,{center:r,eye:s}=i,n=Math.abs(e.getAltitude(r)),a=Math.abs(Math.PI/2-dl(e,r,s));return In(nr,e.referenceEllipsoid.radius+n),En(nr,a,i.distance,i.fovY)}const wl={minCurvature:oe(5),maxCurvature:oe(50),minSamples:1,maxSamples:6},Sl=K(1,0,0),Ml=K(0,1,0),Tl=g(),Cl=g(),Q=g(),nr=Ft(),Pl=Vn(),ei=Fe();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:pl,eyeForCenterWithHeadingTilt:vl,eyeTiltToLookAtTilt:gl,headingTiltToDirectionUp:ds,lookAtTiltToEyeTilt:ml,toArea:yl,toExtent:_l},Symbol.toStringTag,{value:"Module"}));const zl={COMPOSITE:"composite-color"},Eh={SSAO:"ssao",LASERLINES:"laserline-color",HIGHLIGHTS:"highlight-color"};let He=class extends fi{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=zl.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([cn(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},un)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new $t("RenderNode:render-function-not-implemented","render() is not implemented.")}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){const e=this._frameBuffer?.getTexture()?.descriptor,i=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return i.fbo?.initializeAndBind(),i}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){switch(e){case 2:this.view.state.fading=!0;case 1:this.view.stage?.renderView.requestRender(e);case 0:case void 0:this._dirty=!0}}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:i})=>i===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}};f([p({constructOnly:!0})],He.prototype,"view",void 0),f([p({constructOnly:!0})],He.prototype,"consumes",void 0),f([p()],He.prototype,"produces",void 0),f([p({readOnly:!0})],He.prototype,"techniques",null),He=f([pi("esri.views.3d.webgl.RenderNode")],He);const Rh=[],Al=[new br("position",3,wr.FLOAT,0,12)],Ol=[new br("position",2,wr.FLOAT,0,8)],Fh=$r(Ol);$r(Al);function Dh(t,e=!0){t.attributes.add("position","vec2"),e&&t.varyings.add("uv","vec2"),t.vertex.main.add(m`
      gl_Position = vec4(position, 0.0, 1.0);
      ${e?m`uv = position * 0.5 + vec2(0.5);`:""}
  `)}function El(t){t.uniforms.add(new bi("zProjectionMap",e=>Il(e.camera))),t.code.add(m`float linearizeDepth(float depth) {
float depthNdc = depth * 2.0 - 1.0;
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
return -(c1 / (depthNdc + c2 + 1e-7));
}`),t.code.add(m`float delinearizeDepth(float linearDepth) {
float c1 = zProjectionMap[0];
float c2 = zProjectionMap[1];
float depthNdc = (-c1/linearDepth) - c2 - 1e-7;
float depthNonlinear01 = (depthNdc + 1.0 ) / 2.0;
return depthNonlinear01;
}`),t.code.add(m`float depthFromTexture(sampler2D depthTexture, vec2 uv) {
ivec2 iuv = ivec2(uv * vec2(textureSize(depthTexture, 0)));
float depth = texelFetch(depthTexture, iuv, 0).r;
return depth;
}`),t.code.add(m`float linearDepthFromTexture(sampler2D depthTexture, vec2 uv) {
return linearizeDepth(depthFromTexture(depthTexture, uv));
}`)}function Il(t){const e=t.projectionMatrix;return oi(Rl,e[14],e[10])}const Rl=_i();let Lh=class extends j{constructor(e,i,r){super(e,"vec2",2,(s,n,a,o)=>s.setUniform2fv(e,i(n,a,o),r))}},Fl=class extends j{constructor(e,i,r){super(e,"vec4",0,(s,n)=>s.setUniform4fv(e,i(n),r))}};function Nh(t){t.fragment.uniforms.add(new Fl("projInfo",e=>Dl(e.camera))),t.fragment.uniforms.add(new bi("zScale",e=>Ll(e.camera))),t.fragment.code.add(m`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function Dl(t){const e=t.projectionMatrix;return e[11]===0?zt(ar,2/(t.fullWidth*e[0]),2/(t.fullHeight*e[5]),(1+e[12])/e[0],(1+e[13])/e[5]):zt(ar,-2/(t.fullWidth*e[0]),-2/(t.fullHeight*e[5]),(1-e[8])/e[0],(1-e[9])/e[5])}const ar=Fe();function Ll(t){return t.projectionMatrix[11]===0?oi(or,0,1):oi(or,1,0)}const or=_i();function Bh(t){const e=3.141592653589793,i=.3183098861837907;t.constants.add("PI","float",e),t.constants.add("LIGHT_NORMALIZATION","float",i),t.constants.add("INV_PI","float",i),t.constants.add("HALF_PI","float",1.570796326794897),t.constants.add("TWO_PI","float",6.28318530717958)}let Hh=class extends j{constructor(e,i){super(e,"bool",0,(r,s)=>r.setUniform1b(e,i(s)))}},Vl=class{constructor(e=rt()){this.intensity=e}};class kl{constructor(e=rt(),i=K(.57735,.57735,.57735)){this.intensity=e,this.direction=i}}class ui{constructor(e=rt(),i=K(.57735,.57735,.57735),r=!0,s=1,n=1){this.intensity=e,this.direction=i,this.castShadows=r,this.specularStrength=s,this.environmentStrength=n}}let ps=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function Nl(t,e,i){(i=i||t).length=t.length;for(let r=0;r<t.length;r++)i[r]=t[r]*e[r];return i}function ti(t,e,i){(i=i||t).length=t.length;for(let r=0;r<t.length;r++)i[r]=t[r]*e;return i}function Xe(t,e,i){(i=i||t).length=t.length;for(let r=0;r<t.length;r++)i[r]=t[r]+e[r];return i}function vs(t){return(t+1)*(t+1)}function Bl(t){return nt(Math.floor(Math.sqrt(t)-1),0,2)}function ms(t,e,i){const r=t[0],s=t[1],n=t[2],a=i||[];return a.length=vs(e),e>=0&&(a[0]=.28209479177),e>=1&&(a[1]=.4886025119*r,a[2]=.4886025119*n,a[3]=.4886025119*s),e>=2&&(a[4]=1.09254843059*r*s,a[5]=1.09254843059*s*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*r*n,a[8]=.54627421529*(r*r-s*s)),a}function Hl(t,e){const i=vs(t),r=e||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function jl(t,e){const i=Bl(e.r.length);for(const r of t)yr(hi,r.direction),ms(hi,i,be),Nl(be,Mt),ti(be,r.intensity[0],je),Xe(e.r,je),ti(be,r.intensity[1],je),Xe(e.g,je),ti(be,r.intensity[2],je),Xe(e.b,je);return e}function Ul(t,e){ms(hi,0,be);for(const i of t)e.r[0]+=be[0]*Mt[0]*i.intensity[0]*4*Math.PI,e.g[0]+=be[0]*Mt[0]*i.intensity[1]*4*Math.PI,e.b[0]+=be[0]*Mt[0]*i.intensity[2]*4*Math.PI;return e}function ql(t,e,i,r){Hl(e,r),k(i.intensity,0,0,0);let s=!1;const n=Wl,a=Gl,o=Xl;n.length=0,a.length=0,o.length=0;for(const l of t)l instanceof ui&&!s?(U(i.direction,l.direction),U(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,s=!0):l instanceof ui||l instanceof kl?n.push(l):l instanceof Vl?a.push(l):l instanceof ps&&o.push(l);jl(n,r),Ul(a,r);for(const l of o)Xe(r.r,l.r),Xe(r.g,l.g),Xe(r.b,l.b)}const Wl=[],Gl=[],Xl=[],be=[0],je=[0],hi=g(),Mt=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class lr{constructor(){this.color=g(),this.intensity=1}}class Yl{constructor(){this.direction=g(),this.ambient=new lr,this.diffuse=new lr}}const Kl=.4;class Wh{constructor(){this._shOrder=2,this._legacy=new Yl,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new ps,this._mainLight=new ui(g(),K(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){ql(e,this._shOrder,this._mainLight,this._sphericalHarmonics),this.updateLegacy()}updateLegacy(){U(this._legacy.direction,this._mainLight.direction);const e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,W(this._legacy.diffuse.color,this._mainLight.intensity,e),U(xt,this._legacy.diffuse.color),W(xt,xt,Kl*this.globalFactor),ae(this._legacy.ambient.color,this._legacy.ambient.color,xt)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),U(this._mainLight.direction,e.mainLight.direction),U(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,i,r){if(Tt(this._mainLight.intensity,e.mainLight.intensity,i.mainLight.intensity,r),this._mainLight.environmentStrength=te(e.mainLight.environmentStrength,i.mainLight.environmentStrength,r),this._mainLight.specularStrength=te(e.mainLight.specularStrength,i.mainLight.specularStrength,r),U(this._mainLight.direction,i.mainLight.direction),this._mainLight.castShadows=i.mainLight.castShadows,this.globalFactor=te(e.globalFactor,i.globalFactor,r),this.noonFactor=te(e.noonFactor,i.noonFactor,r),e.sh.r.length===i.sh.r.length)for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=te(e.sh.r[s],i.sh.r[s],r),this._sphericalHarmonics.g[s]=te(e.sh.g[s],i.sh.g[s],r),this._sphericalHarmonics.b[s]=te(e.sh.b[s],i.sh.b[s],r);else for(let s=0;s<i.sh.r.length;s++)this._sphericalHarmonics.r[s]=i.sh.r[s],this._sphericalHarmonics.g[s]=i.sh.g[s],this._sphericalHarmonics.b[s]=i.sh.b[s];this.updateLegacy()}}const xt=g();function Gh(t,{occlusionPass:e,terrainDepthTest:i,cullAboveTerrain:r}){const{vertex:s,fragment:n,varyings:a}=t;if(!i)return s.code.add("void forwardViewPosDepth(vec3 pos) {}"),void n.code.add(`${e?"bool":"void"} discardByTerrainDepth() { ${se(e,"return false;")}}`);a.add("viewPosDepth","float",{invariant:!0}),s.code.add(`void forwardViewPosDepth(vec3 pos) {
    viewPosDepth = pos.z;
  }`),n.include(El),n.uniforms.add(new es("terrainDepthTexture",o=>o.terrainDepth?.attachment)).code.add(m`
    ${e?"bool":"void"} discardByTerrainDepth() {
      float depth = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0).r;
      float linearDepth = linearizeDepth(depth);
      ${e?"return viewPosDepth < linearDepth && depth < 1.0;":`if(viewPosDepth ${r?">":"<="} linearDepth) discard;`}
    }`)}function Zl(t){t.code.add(m`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function Ql(t){t.code.add(m`
    const float GAMMA = ${m.float(Vi)};
    const float INV_GAMMA = ${m.float(1/Vi)};

    vec4 delinearizeGamma(vec4 color) {
      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.a);
    }

    vec3 linearizeGamma(vec3 color) {
      return pow(color, vec3(GAMMA));
    }
  `)}const Jl=1;function ec(t,e){if(!st(e.output))return;t.fragment.include(Ql);const{emissionSource:i,hasEmissiveTextureTransform:r,bindType:s}=e,n=i===3||i===4||i===5;n&&(t.include(Go,e),t.fragment.uniforms.add(s===1?new qo("texEmission",h=>h.textureEmissive):new Xo("texEmission",h=>h.textureEmissive)));const a=i===2||n;a&&t.fragment.uniforms.add(s===1?new xe("emissiveBaseColor",h=>h.emissiveBaseColor):new Te("emissiveBaseColor",h=>h.emissiveBaseColor));const o=i!==0;o&&!(i===7||i===6||i===4||i===5)&&t.fragment.uniforms.add(s===1?new jo("emissiveStrength",h=>h.emissiveStrength):new Ho("emissiveStrength",h=>h.emissiveStrength));const l=i===7,u=i===5,c=i===1||i===6||l;t.fragment.code.add(m`
    vec4 getEmissions(vec3 symbolColor) {
      vec4 emissions = ${a?u?"emissiveSource == 0 ? vec4(emissiveBaseColor, 1.0): vec4(linearizeGamma(symbolColor), 1.0)":"vec4(emissiveBaseColor, 1.0)":c?l?"emissiveSource == 0 ? vec4(0.0): vec4(linearizeGamma(symbolColor), 1.0)":"vec4(linearizeGamma(symbolColor), 1.0)":"vec4(0.0)"};
      ${se(n,`${se(u,`if(emissiveSource == 0) {
              vec4 emissiveFromTex = textureLookup(texEmission, ${r?"emissiveUV":"vuv0"});
              emissions *= vec4(linearizeGamma(emissiveFromTex.rgb), emissiveFromTex.a);
           }`,`vec4 emissiveFromTex = textureLookup(texEmission, ${r?"emissiveUV":"vuv0"});
           emissions *= vec4(linearizeGamma(emissiveFromTex.rgb), emissiveFromTex.a);`)}
        emissions.w = emissions.rgb == vec3(0.0) ? 0.0: emissions.w;`)}
      ${se(o,`emissions.rgb *= emissiveStrength * ${m.float(Jl)};`)}
      return emissions;
    }
  `)}function Xh(t,e){t.include(Po,e),t.include(ec,e),t.fragment.include(Zl);const{output:i,oitPass:r,discardInvisibleFragments:s,snowCover:n}=e,a=i===10,o=xi(i),l=st(i)&&r===1,u=st(i)&&r!==1;let c=0;(u||o||l)&&t.outputs.add("fragColor","vec4",c++),o&&t.outputs.add("fragEmission","vec4",c++),l&&t.outputs.add("fragAlpha","float",c++),t.fragment.code.add(m`
    void outputColorHighlightOID(vec4 finalColor, const in vec3 vWorldPosition, vec3 emissiveSymbolColor ${se(n,", float snow")}) {
      ${se(a,"finalColor.a = 1.0;")}

      ${se(s,`if (finalColor.a < ${m.float(Uo)}) { discard; }`)}

      finalColor = applySlice(finalColor, vWorldPosition);
      ${se(l,m`fragColor = premultiplyAlpha(finalColor);
             fragAlpha = finalColor.a;`)}
      ${se(u,"fragColor = finalColor;")}
      ${se(o,`fragEmission = ${se(n,"mix(finalColor.a * getEmissions(emissiveSymbolColor), vec4(0.0), snow);","finalColor.a * getEmissions(emissiveSymbolColor);")}`)}
      calculateOcclusionAndOutputHighlight();
      ${se(a,"outputObjectAndLayerIdColor();")}
    }
  `)}export{Lr as $,qc as A,iu as B,su as C,Wu as D,Bu as E,eh as F,wh as G,ah as H,Lu as I,Xh as J,Gh as K,Jr as L,Zl as M,Qc as N,Ru as O,Iu as P,Ou as Q,Pu as R,yc as S,Kc as T,Jc as U,Yc as V,eu as W,st as X,et as Y,Pc as Z,Wh as _,oo as a,$u as a$,Cc as a0,Zc as a1,Uo as a2,pu as a3,$h as a4,$a as a5,ua as a6,mc as a7,xo as a8,_o as a9,Yu as aA,wc as aB,pa as aC,go as aD,Ao as aE,Bh as aF,St as aG,bi as aH,Oa as aI,Du as aJ,Au as aK,Fu as aL,Eu as aM,zu as aN,Fr as aO,ya as aP,fu as aQ,nu as aR,uu as aS,xh as aT,El as aU,Gc as aV,Hc as aW,no as aX,Lt as aY,Hu as aZ,po as a_,Fl as aa,so as ab,wo as ac,Gu as ad,Xu as ae,$o as af,Hh as ag,es as ah,Vu as ai,Ch as aj,th as ak,Po as al,_a as am,Nc as an,Sa as ao,Bo as ap,jc as aq,Ya as ar,Ka as as,Qa as at,Ut as au,hu as av,qr as aw,du as ax,eo as ay,Oc as az,qo as b,mo as b0,Ku as b1,Zu as b2,Uc as b3,yo as b4,Nu as b5,Go as b6,Nh as b7,Kl as b8,Te as b9,To as ba,nh as bb,vo as bc,Tc as bd,ga as be,rh as bf,gh as bg,_h as bh,mh as bi,Oh as bj,yh as bk,gc as bl,ru as bm,Wt as bn,zo as bo,Ea as bp,Ha as bq,to as br,Ql as bs,Gi as bt,Dr as bu,io as bv,xe as c,Dt as d,la as e,Qu as f,Lh as g,ca as h,j as i,Tu as j,wu as k,So as l,Mc as m,vc as n,Dh as o,Rh as p,Xo as q,jo as r,Fh as s,Un as t,He as u,Eh as v,Ah as w,ht as x,Ta as y,Vl as z};
